{% extends "core/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Analytics Dashboard | CHIETA{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" referrerpolicy="no-referrer" />
<style>
:root {
    --chi-purple: #3a063a;
    --chi-purple-dark: #280427;
    --chi-purple-200: #580658;
    --chi-gold: #8f6620;
    --chi-sand: #b8832a;
    --chi-slate: #403675;
}

body {
    margin: 0;
    font-family: Georgia, 'Times New Roman', Times, serif;
    background-color: #ecf0f1;
}

.dashboard-container {
    display: flex;
    flex-direction: row;
    min-height: 100vh;
}

.sidebar ul li {
    transition: background-color 0.3s ease;
    border-top: 1.5px solid #580658;
    border-radius: 10px;
    color: #580658;
}

.fixy {
    border-color: #ffffff;
    width: 100%;
    height: 40px;
    color: whitesmoke;
    border-radius: 10px;
    margin-bottom: -2px;
    background-color: #8f6620;
}

.fix {
    width: 100%;
    height: 40px;
    border-radius: 10px;
    color: whitesmoke;
    border-color: #f9f9f9;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
}

button:hover {
    background-color: #ffffff;
    color: #4d4747;
    border-color: #007BFF;
}

.sidebar ul li:hover {
    background-color: #8f6620;
    color: white;
    cursor: pointer;
    border-radius: 10px;
    height: 30px;
    list-style: none;
}

.nav-item {
    color: rgb(81, 3, 102);
    text-decoration: none;
    transition: color 0.3s;
    font-size: 16px;
}

.nav-item:hover {
    color: rgb(249, 249, 249);
    transition: color 0.3s;
}

.sidebar {
    width: 210px;
    min-height: 100vh;
    font-size: 13px;
    background: linear-gradient(to bottom, rgb(195, 193, 193), white, rgb(160, 160, 160), rgb(240, 239, 239), rgb(240, 239, 239), rgb(91, 60, 131));
    padding: 20px;
    border-radius: 0px 0px 0px 0px;
    border-right: 1px solid #8f6620;
    box-shadow: inset 0 -2px 3px rgba(75, 0, 130, 0.7);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    overflow-y: auto;
}

.sidebar .graduate-icon {
    border-radius: 20px;
    height: 110px;
    width: 105px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-left: auto;
    margin-right: auto;
}

.sidebar ul {
    list-style-type: none;
    padding: 0;
}

.sidebar ul li {
    margin: 20px 0;
    display: flex;
    align-items: center;
}

.sidebar ul li i {
    margin-right: 10px;
}

.content {
    flex-grow: 1;
    padding: 20px;
    margin-left: 240px;
    width: calc(100% - 240px);
    background-color: #efeaea;
    background-image: url("{% static 'core/images/Frame.png' %}");
    background-repeat: no-repeat;
    background-size: cover;
    opacity: 0.9;
}

.topbar {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
}

.topbar input[type="search"] {
    padding: 10px;
    width: 70%;
    border-radius: 20px;
    border: 1px solid #ccc;
}

.welcome-box {
    background: linear-gradient(to right, white, rgb(215, 213, 213), rgb(240, 239, 239), rgb(91, 60, 131));
    background-size: cover;
    background-position: center;
    padding: 20px;
    margin-top: 20px;
    font-size: 20px;
    font-weight: bold;
    color: #4d4747;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    text-align: left;
    min-height: 25vh;
    position: relative;
    border-left: 4px solid rgb(81, 3, 102);
}

.welcome-box .date {
    font-size: 14px;
    margin-top: 5px;
    font-weight: normal;
}

.date {
    font-size: 16px;
    color: grey;
}

.gradient-button {
    background-color: #3a063a;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 12px;
    margin-top: 10px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.gradient-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    background-color: #8f6620;
}

.dashboard-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin: 1.5rem 0;
    border-bottom: 1px solid rgba(88, 6, 88, 0.2);
    padding-bottom: 0.5rem;
}

.dashboard-tab {
    border: 1px solid rgba(88, 6, 88, 0.2);
    border-radius: 999px;
    padding: 0.4rem 1.2rem;
    background: rgba(255, 255, 255, 0.8);
    color: #3a063a;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.dashboard-tab.active {
    background: linear-gradient(135deg, #3a063a, #8f6620);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 8px 16px rgba(58, 6, 58, 0.25);
}

.tab-panel {
    display: none;
}

.tab-panel.is-active {
    display: block;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.export-chart-btn {
    border: none;
    background: transparent;
    color: #3a063a;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
}

.export-chart-btn:hover,
.export-chart-btn:focus {
    color: #8f6620;
    text-decoration: none;
}

.export-chart-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.global-summary .stat-card {
    min-height: 150px;
}

.global-summary .stat-value {
    font-size: 2rem;
}

.compare-multiselect {
    min-height: 130px;
}

.empty-state {
    border: 1px dashed rgba(58, 6, 58, 0.3);
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    color: #6c6c6c;
    background-color: rgba(255, 255, 255, 0.8);
}


.highlight {
    color: red;
    font-weight: bold;
    text-decoration: underline;
    cursor: pointer;
}

.welcome-container {
    position: relative;
    margin: 20px;
}

.image-container {
    position: absolute;
    top: -37px;
    right: 0;
    z-index: 2;
}

/* Card and table styling updates */
.card {
    background: linear-gradient(to right, white, rgb(240, 239, 239));
    border: 1px solid #8f6620;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.card-header {
    background: linear-gradient(to right, #3a063a, #580658);
    color: white;
    font-weight: bold;
    border-bottom: 1px solid #8f6620;
}

.table-dark {
    background: linear-gradient(to right, #3a063a, #580658) !important;
    color: white;
}

.table-hover tbody tr:hover {
    background-color: rgba(143, 102, 32, 0.1);
}

.btn-outline-primary {
    border-color: #3a063a;
    color: #3a063a;
}

.btn-outline-primary:hover {
    background-color: #3a063a;
    color: white;
}

.btn-outline-success {
    border-color: #8f6620;
    color: #8f6620;
}

.btn-outline-success:hover {
    background-color: #8f6620;
    color: white;
}

.btn-success {
    background-color: #3a063a;
    border-color: #3a063a;
}

.btn-success:hover {
    background-color: #8f6620;
    border-color: #8f6620;
}

.btn-outline-warning {
    border-color: #8f6620;
    color: #8f6620;
}

.btn-outline-warning:hover {
    background-color: #8f6620;
    color: white;
}

.badge.bg-primary {
    background-color: #3a063a !important;
}

.badge.bg-success {
    background-color: #8f6620 !important;
}

.alert-info {
    background-color: rgba(143, 102, 32, 0.1);
    border-color: #8f6620;
    color: #3a063a;
}

/* Admin specific styles */
.btn-etqa {
    background-color: #3a063a;
    border-color: #3a063a;
    color: white;
}

.btn-etqa:hover {
    background-color: #8f6620;
    border-color: #8f6620;
    color: white;
}

.logout-btn {
    padding: 7px 7px;
    margin-top: 10px;
    font-size: 14px;
    background-color: #3a063a;
    color: white;
    text-align: left;
    border-radius: 6px;
    text-decoration: none;
    transition: background-color 0.3s ease;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logout-btn:hover {
    background-color: #8f6620;
    color: white;
}

/* Analytics Dashboard specific styles */
.dashboard-page {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 18px;
    padding: 24px;
    box-shadow: 0 25px 45px rgba(58, 6, 58, 0.12);
}

.page-heading {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--chi-purple-dark);
}

.text-accent {
    color: var(--chi-purple);
}

.dashboard-filter label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: #6f587d;
    font-weight: 600;
}

.dashboard-filter .form-select,
.dashboard-filter .form-control {
    min-width: 160px;
}

.stat-card {
    background: linear-gradient(135deg, var(--chi-purple), var(--chi-purple-200));
    color: #fff;
    border-radius: 1rem;
    padding: 1.4rem;
    min-height: 160px;
    box-shadow: 0 10px 24px rgba(58, 6, 58, 0.18);
    display: flex;
    flex-direction: column;
    gap: .4rem;
    position: relative;
    overflow: hidden;
}

.stat-card[data-variant="gold"] {
    background: linear-gradient(135deg, var(--chi-gold), var(--chi-sand));
}

.stat-card[data-variant="slate"] {
    background: linear-gradient(135deg, var(--chi-slate), #6c4aa0);
}

.stat-card[data-variant="neutral"] {
    background: #fff;
    color: var(--chi-purple-dark);
    border: 1px solid rgba(90, 62, 123, 0.12);
    box-shadow: 0 8px 16px rgba(40, 4, 39, 0.08);
}

.stat-card .stat-label {
    text-transform: uppercase;
    font-size: .72rem;
    letter-spacing: .12em;
    font-weight: 700;
    opacity: .85;
}

.stat-card[data-variant="neutral"] .stat-label {
    color: #6f6f6f;
}

.stat-card .stat-value {
    font-size: 2.4rem;
    font-weight: 700;
}

.stat-card .stat-foot {
    margin-top: auto;
}

.stat-chip {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    background: rgba(255, 255, 255, 0.14);
    padding: .2rem .6rem;
    border-radius: 999px;
    font-size: .75rem;
    font-weight: 600;
}

[data-variant="neutral"] .stat-chip {
    background: rgba(58, 6, 58, 0.08);
    color: var(--chi-purple);
}

.card.shadow-sm {
    border-radius: 1rem;
    border: 1px solid rgba(88, 6, 88, 0.12);
}

.card-header {
    border-bottom: 0;
    background: transparent;
    font-weight: 600;
    color: var(--chi-purple-dark);
    padding: 1rem 1.5rem 0;
}

.card-body {
    padding: 1rem 1.5rem 1.5rem;
    max-height: 450px;
    overflow-y: auto;
}

.chart-canvas {
    width: 100%;
    height: 350px;
    max-height: 350px;
}

.chart-empty {
    border: 1px dashed rgba(58, 6, 58, 0.25);
    border-radius: .75rem;
    padding: 1rem;
    text-align: center;
    font-style: italic;
    font-size: .9rem;
    margin: .5rem 0 0;
}

.table-dashboard thead {
    background: linear-gradient(90deg, rgba(58, 6, 58, 0.85), rgba(143, 102, 32, 0.85));
    color: #fff;
}

.table-dashboard tbody tr:hover {
    background-color: rgba(143, 102, 32, 0.08);
}

.badge-pass-strong {
    background-color: #2f9d57;
}

.badge-pass-mid {
    background-color: #f6c343;
    color: #3a063a;
}

.badge-pass-low {
    background-color: #e55353;
}

.metric-kpi {
    font-size: .85rem;
    font-weight: 600;
}

.metric-kpi .trend-up {
    color: #2f9d57;
}

.metric-kpi .trend-down {
    color: #e55353;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .content {
        margin-left: 220px;
        width: calc(100% - 220px);
    }

    .image-container {
        position: relative;
        top: 0;
        margin-bottom: 15px;
    }

    .welcome-box {
        height: auto;
        padding-bottom: 30px;
    }
}

@media (max-width: 992px) {
    .sidebar {
        width: 180px;
    }

    .content {
        margin-left: 190px;
        width: calc(100% - 190px);
    }

    .image-container img {
        width: 300px;
        height: auto;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        flex-direction: column;
    }

    .sidebar {
        position: relative;
        width: 100%;
        min-height: auto;
        height: auto;
        padding: 10px;
    }

    .content {
        margin-left: 0;
        width: 100%;
    }

    .topbar input[type="search"] {
        width: 90%;
    }

    .welcome-box {
        height: auto;
        padding: 15px;
    }

    .image-container {
        position: relative;
        top: 0;
        left: 0;
        text-align: center;
    }

    .image-container img {
        width: 250px;
        height: auto;
    }

    .gradient-button {
        display: flex;
        justify-content: center;
        margin-left: 0;
        align-items: center;
    }
    
    .dashboard-filter .form-select,
    .dashboard-filter .form-control {
        min-width: 0;
    }

    .stat-card {
        min-height: 140px;
    }

    .chart-canvas {
        height: 300px;
        max-height: 300px;
    }
}

@media (max-width: 576px) {
    .sidebar {
        padding: 10px 5px;
    }

    .sidebar .graduate-icon {
        width: 80px;
        height: 80px;
    }

    .topbar input[type="search"] {
        width: 80%;
    }

    .sidebar ul li {
        margin: 10px 0;
        justify-content: center;
    }

    .welcome-box {
        font-size: 18px;
        height: auto;
        padding: 10px;
    }

    .table-responsive {
        font-size: 14px;
    }
}

@media (max-width: 400px) {
    .sidebar {
        width: 100%;
        padding: 5px;
    }

    .sidebar ul li {
        font-size: 12px;
    }

    .fixy,
    .fix {
        font-size: 12px;
    }

    .content {
        padding: 10px;
    }

    .welcome-box {
        font-size: 16px;
    }

    .gradient-button {
        padding: 8px 15px;
        font-size: 11px;
    }
}
</style>

{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% include "core/administrator/_sidebar.html" %}
    <div class="content" data-dashboard-container data-active-tab="{{ active_tab|default:'analytics' }}">
        <!-- Welcome Box -->
        <div class="welcome-container">
            <div class="image-container">
                <!-- <img src="{% static 'core/images/rb_2148892786.png' %}" alt="Profile Picture" width="390px" height="190px"> -->
            </div>
            <div class="welcome-box">
                <h2><i class="fas fa-chart-line me-2"></i>Analytics Dashboard</h2>
                <div class="date">
                    Monitor system performance, learner progress, and assessment outcomes.
                    <br>Track key metrics, identify trends, and make data-driven decisions.
                    <span class="highlight">Real-time insights at your fingertips!</span>
                    <br>
                </div>
                <button class="gradient-button">Data-Driven Excellence</button>
            </div>
        </div>

        <div class="topbar">
            <input type="search" placeholder="Search analytics...">
        </div>
        
        <div class="dashboard-tabs">
            <button type="button" class="dashboard-tab{% if active_tab == 'analytics' %} active{% endif %}" data-tab-trigger="analytics">
                <i class="fas fa-chart-pie"></i> Analytics Overview
            </button>
            <!-- <button type="button" class="dashboard-tab{% if active_tab == 'global' %} active{% endif %}" data-tab-trigger="global">
                <i class="fas fa-globe-africa"></i> Global Business
            </button> -->
        </div>
        
        <section class="tab-panel {% if active_tab == 'analytics' %}is-active{% endif %}" data-tab-panel="analytics">
            <div class="dashboard-page">
            <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
                <div>
                    <h1 class="page-heading mb-1">
                        <i class="fas fa-chart-line me-2 text-accent"></i>
                        Analytics Dashboard
                    </h1>
                    <p class="text-muted mb-0">Live indicators sourced from assessments, submissions, and learner records.</p>
                </div>
                <form method="get" class="row g-2 dashboard-filter align-items-end" data-tab-aware-form>
                    <input type="hidden" name="tab" value="{{ active_tab|default:'analytics' }}">
                    <div class="col-auto">
                        <label class="form-label">Qualification</label>
                        <select class="form-select form-select-sm" name="qualification">
                            <option value="">All</option>
                            {% if qualifications %}
                                {% for qualification in qualifications %}
                                    {% with qid=qualification.id|stringformat:"s" %}
                                        <option value="{{ qid }}" {% if request.GET.qualification == qid %}selected{% endif %}>
                                            {{ qualification.name }}
                                        </option>
                                    {% endwith %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label">Period</label>
                        <select class="form-select form-select-sm" name="period">
                            {% if period_options %}
                                {% for value,label in period_options %}
                                    <option value="{{ value }}" {% if request.GET.period == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            {% else %}
                                {% with current=request.GET.period %}
                                    <option value="30d" {% if current == "30d" or not current %}selected{% endif %}>Last 30 days</option>
                                    <option value="90d" {% if current == "90d" %}selected{% endif %}>Last 90 days</option>
                                    <option value="365d" {% if current == "365d" %}selected{% endif %}>Last 12 months</option>
                                {% endwith %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label">Assessment type</label>
                        <select class="form-select form-select-sm" name="paper_type">
                            <option value="">All types</option>
                            {% if assessment_type_choices %}
                                {% for value,label in assessment_type_choices %}
                                    <option value="{{ value }}" {% if request.GET.paper_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary btn-sm px-3">Apply</button>
                            {% if request.GET %}
                                <a href="{{ request.path }}" class="btn btn-outline-secondary btn-sm ms-1">Reset</a>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>

            {% with metrics=metrics %}
            <div class="row g-3 mb-4">
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card">
                        <span class="stat-label">Registered learners</span>
                        <span class="stat-value">
                            {{ metrics.total_learners|default:0|intcomma }}
                        </span>
                        <span class="stat-foot stat-chip">
                            <i class="fas fa-graduation-cap me-1"></i>
                            {{ metrics.active_qualifications|default:0|intcomma }} active qualifications
                        </span>
                    </div>
                </div>
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card" data-variant="gold">
                        <span class="stat-label">Assessments completed</span>
                        <span class="stat-value">
                            {{ metrics.completed_assessments|default:0|intcomma }}
                        </span>
                        <span class="stat-foot metric-kpi">
                            {% with delta=metrics.completed_assessments_delta %}
                                {% if delta or delta == 0 %}
                                    {% if delta >= 0 %}
                                        <span class="trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>{{ delta|floatformat:1 }}% vs prev.
                                        </span>
                                    {% else %}
                                        <span class="trend-down">
                                            <i class="fas fa-arrow-down me-1"></i>{{ delta|floatformat:1 }}% vs prev.
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Change data not available</span>
                                {% endif %}
                            {% endwith %}
                        </span>
                    </div>
                </div>
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card" data-variant="slate">
                        <span class="stat-label">Overall pass rate</span>
                        <span class="stat-value">
                            {{ metrics.overall_pass_rate|default:0|floatformat:1 }}%
                        </span>
                        <span class="stat-foot metric-kpi">
                            {% with rate_delta=metrics.pass_rate_delta %}
                                {% if rate_delta or rate_delta == 0 %}
                                    {% if rate_delta >= 0 %}
                                        <span class="trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>{{ rate_delta|floatformat:1 }}pts gain
                                        </span>
                                    {% else %}
                                        <span class="trend-down">
                                            <i class="fas fa-arrow-down me-1"></i>{{ rate_delta|floatformat:1 }}pts drop
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">No comparative period selected</span>
                                {% endif %}
                            {% endwith %}
                        </span>
                    </div>
                </div>
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card" data-variant="neutral">
                        <span class="stat-label">Randomized papers</span>
                        <span class="stat-value text-accent">
                            {{ metrics.randomized_papers|default:0|intcomma }}
                        </span>
                        <span class="stat-foot metric-kpi">
                            <span class="stat-chip">
                                {{ metrics.randomized_share|default:0|floatformat:1 }}% of active tools
                            </span>
                        </span>
                    </div>
                </div>
            </div>
            {% endwith %}

            <div class="row g-3 mb-4">
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100" id="pass-rate-card">
                        <div class="card-header chart-header">
                            <span>Pass rate by qualification</span>
                            <button type="button" class="export-chart-btn" data-chart-target="pass-rate-chart">
                                <i class="fas fa-download"></i> Export PNG
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="pass-rate-chart" aria-label="Pass rate by qualification" role="img" class="chart-canvas"></canvas>
                            <p class="chart-empty text-muted small mb-0">No pass rate data available for the current filters.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100" id="completion-card">
                        <div class="card-header chart-header">
                            <span>Assessment completion trend</span>
                            <button type="button" class="export-chart-btn" data-chart-target="completion-chart">
                                <i class="fas fa-download"></i> Export PNG
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="completion-chart" aria-label="Assessment completion trend" role="img" class="chart-canvas"></canvas>
                            <p class="chart-empty text-muted small mb-0">No completion trend data available for the selected window.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-lg-4">
                    <div class="card shadow-sm h-100" id="assessment-type-card">
                        <div class="card-header chart-header">
                            <span>Assessment type mix</span>
                            <button type="button" class="export-chart-btn" data-chart-target="assessment-type-chart">
                                <i class="fas fa-download"></i> Export PNG
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="assessment-type-chart" aria-label="Assessment type distribution" role="img" class="chart-canvas"></canvas>
                            <p class="chart-empty text-muted small mb-0">No assessment type distribution recorded.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card shadow-sm h-100" id="enrollment-card">
                        <div class="card-header chart-header">
                            <span>Learner enrollment by qualification</span>
                            <button type="button" class="export-chart-btn" data-chart-target="enrollment-chart">
                                <i class="fas fa-download"></i> Export PNG
                            </button>
                        </div>
                        <div class="card-body">
                            <canvas id="enrollment-chart" aria-label="Enrollment by qualification" role="img" class="chart-canvas"></canvas>
                            <p class="chart-empty text-muted small mb-0">No enrollment data available.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">Qualification performance detail</div>
                {% if course_statistics %}
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dashboard table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th scope="col" class="ps-4">Qualification</th>
                                        <th scope="col">Learners</th>
                                        <th scope="col">Completed</th>
                                        <th scope="col">Pass rate</th>
                                        <th scope="col">Average score</th>
                                        <th scope="col">Written papers</th>
                                        <th scope="col">Randomized</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for course in course_statistics %}
                                        <tr>
                                            <td class="ps-4">
                                                <div class="fw-semibold">{{ course.qualification|default:"-" }}</div>
                                                {% if course.latest_assessment %}
                                                    <div class="text-muted small">Latest tool: {{ course.latest_assessment }}</div>
                                                {% endif %}
                                            </td>
                                            <td>{{ course.total_learners|default:0|intcomma }}</td>
                                            <td>{{ course.completed_learners|default:0|intcomma }}</td>
                                            <td>
                                                {% with rate=course.pass_rate %}
                                                    {% if rate or rate == 0 %}
                                                        {% if rate >= 75 %}
                                                            <span class="badge badge-pass-strong">{{ rate|floatformat:0 }}%</span>
                                                        {% elif rate >= 50 %}
                                                            <span class="badge badge-pass-mid">{{ rate|floatformat:0 }}%</span>
                                                        {% else %}
                                                            <span class="badge badge-pass-low">{{ rate|floatformat:0 }}%</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted small">n/a</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                            <td>
                                                {% if course.average_score or course.average_score == 0 %}
                                                    {{ course.average_score|floatformat:1 }}%
                                                {% else %}
                                                    <span class="text-muted small">n/a</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ course.written_count|default:0|intcomma }}</td>
                                            <td>{{ course.randomized_count|default:0|intcomma }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">No qualification level metrics match the selected filters.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="card-body">
                        <p class="text-muted mb-0">No qualification level metrics are available for the selected filters.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        </section>

        <section class="tab-panel {% if active_tab == 'global' %}is-active{% endif %}" data-tab-panel="global">
            <div class="dashboard-page">
                <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
                    <div>
                        <h1 class="page-heading mb-1">
                            <i class="fas fa-globe-africa me-2 text-accent"></i>
                            Global Business Dashboard
                        </h1>
                        <p class="text-muted mb-0">Compare assessment centres by school, country, or continent with exportable charts.</p>
                    </div>
                    <form method="get" class="row g-2 dashboard-filter align-items-end" data-tab-aware-form>
                        <input type="hidden" name="tab" value="{{ active_tab|default:'analytics' }}">
                        <input type="hidden" name="qualification" value="{{ request.GET.qualification|default:'' }}">
                        <input type="hidden" name="period" value="{{ request.GET.period|default:'' }}">
                        <input type="hidden" name="paper_type" value="{{ request.GET.paper_type|default:'' }}">
                        <div class="col-auto">
                            <label class="form-label">Compare by</label>
                            <select class="form-select form-select-sm" name="compare_dim">
                                {% for value,label in global_dimension_choices %}
                                    <option value="{{ value }}" {% if global_compare_dimension == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-auto">
                            <label class="form-label">Values</label>
                            <select class="form-select form-select-sm compare-multiselect" name="compare_values" multiple size="6">
                                {% if global_active_dimension_options %}
                                    {% for option in global_active_dimension_options %}
                                        <option value="{{ option }}" {% if option in global_compare_values %}selected{% endif %}>{{ option }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option disabled>No {{ global_compare_dimension_label|lower }} data</option>
                                {% endif %}
                            </select>
                            <small class="text-muted d-block mt-1">Use Ctrl/Cmd to select multiple entries.</small>
                        </div>
                        <div class="col-auto">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary btn-sm px-3">Apply</button>
                                <a href="?tab=global" class="btn btn-outline-secondary btn-sm ms-1">Reset</a>
                            </div>
                        </div>
                    </form>
                </div>

                {% if global_has_data %}
                <div class="row g-3 mb-4 global-summary">
                    <div class="col-sm-6 col-xl-3">
                        <div class="stat-card">
                            <span class="stat-label">Global learners</span>
                            <span class="stat-value">{{ global_summary.total_learners|default:0|intcomma }}</span>
                            <span class="stat-foot stat-chip">
                                <i class="fas fa-user-friends me-1"></i>{{ global_summary.active_submissions|default:0|intcomma }} submissions
                            </span>
                        </div>
                    </div>
                    <div class="col-sm-6 col-xl-3">
                        <div class="stat-card" data-variant="gold">
                            <span class="stat-label">Active schools</span>
                            <span class="stat-value">{{ global_summary.schools|default:0|intcomma }}</span>
                            <span class="stat-foot stat-chip">Across {{ global_summary.countries|default:0|intcomma }} countries</span>
                        </div>
                    </div>
                    <div class="col-sm-6 col-xl-3">
                        <div class="stat-card" data-variant="slate">
                            <span class="stat-label">Continental reach</span>
                            <span class="stat-value">{{ global_summary.continents|default:0|intcomma }}</span>
                            <span class="stat-foot text-muted">Continents represented</span>
                        </div>
                    </div>
                    <div class="col-sm-6 col-xl-3">
                        <div class="stat-card" data-variant="neutral">
                            <span class="stat-label">Top performer</span>
                            {% if global_summary.top_school %}
                                <span class="stat-value">{{ global_summary.top_school_rate|default:0|floatformat:1 }}%</span>
                                <span class="stat-foot">{{ global_summary.top_school }}</span>
                            {% else %}
                                <span class="stat-value text-muted">n/a</span>
                                <span class="stat-foot text-muted">No submissions yet</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4" id="global-comparison-card">
                    <div class="card-header chart-header">
                        <div>
                            <div class="fw-semibold">Comparison analytics</div>
                            <small class="text-muted">Comparing by {{ global_compare_dimension_label|lower }}</small>
                        </div>
                        <button type="button" class="export-chart-btn" data-chart-target="global-comparison-chart">
                            <i class="fas fa-download"></i> Export PNG
                        </button>
                    </div>
                    <div class="card-body">
                        <canvas id="global-comparison-chart" class="chart-canvas" role="img" aria-label="Global comparison chart"></canvas>
                        <p class="chart-empty text-muted small mb-0">Select at least one {{ global_compare_dimension_label|lower }} to plot analytics.</p>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header">{{ global_compare_dimension_label }} drill-down</div>
                    <div class="table-responsive">
                        <table class="table table-dashboard table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" class="ps-4">{{ global_compare_dimension_label }}</th>
                                    <th scope="col">Learners</th>
                                    <th scope="col">Submissions</th>
                                    <th scope="col">Pass rate</th>
                                    <th scope="col">Average score</th>
                                    <th scope="col">Units</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in global_compare_rows %}
                                    <tr>
                                        <td class="ps-4">
                                            <div class="fw-semibold">{{ row.label }}</div>
                                            {% if global_compare_dimension != 'school' %}
                                                <div class="text-muted small">{{ row.units|default:1|intcomma }} centres</div>
                                            {% endif %}
                                        </td>
                                        <td>{{ row.learners|default:0|intcomma }}</td>
                                        <td>{{ row.submissions|default:0|intcomma }}</td>
                                        <td>{{ row.pass_rate|default:0|floatformat:1 }}%</td>
                                        <td>{{ row.avg_score|default:0|floatformat:1 }}%</td>
                                        <td>{{ row.units|default:1|intcomma }}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">Select values on the right to compare performance.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-info-circle me-2"></i>No global metrics are available for the selected filters yet. Try broadening your filters or ingesting assessment data.
                    </div>
                {% endif %}
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" integrity="sha384-Sse/HDqcypGpyTDpvZOJNnG0TT3feGQUkF9H+mnRvic+LjR+K1NhTt8f51KIQ3v3" crossorigin="anonymous"></script>
{% if pass_rate_data %}
    {{ pass_rate_data|json_script:"pass-rate-data" }}
{% else %}
    <script id="pass-rate-data" type="application/json">[]</script>
{% endif %}
{% if completion_trend_data %}
    {{ completion_trend_data|json_script:"completion-trend-data" }}
{% else %}
    <script id="completion-trend-data" type="application/json">[]</script>
{% endif %}
{% if assessment_type_breakdown %}
    {{ assessment_type_breakdown|json_script:"assessment-type-data" }}
{% else %}
    <script id="assessment-type-data" type="application/json">{}</script>
{% endif %}
{% if enrollment_by_course_data %}
    {{ enrollment_by_course_data|json_script:"enrollment-data" }}
{% else %}
    <script id="enrollment-data" type="application/json">[]</script>
{% endif %}
{% if global_compare_chart_data %}
    {{ global_compare_chart_data|json_script:"global-compare-data" }}
{% else %}
    <script id="global-compare-data" type="application/json">[]</script>
{% endif %}
<script>
(function () {
    function safeParse(id, fallback) {
        var el = document.getElementById(id);
        if (!el) { return fallback; }
        var payload = el.textContent && el.textContent.trim();
        if (!payload) { return fallback; }
        try {
            return JSON.parse(payload);
        } catch (err) {
            console.warn('Unable to parse dataset for', id, err);
            return fallback;
        }
    }

    function toggleEmptyState(container, hasData) {
        if (!container) { return; }
        var canvas = container.querySelector('canvas');
        var empty = container.querySelector('.chart-empty');
        var exportBtn = container.querySelector('.export-chart-btn');
        if (canvas) {
            canvas.classList.toggle('d-none', !hasData);
        }
        if (empty) {
            empty.classList.toggle('d-none', !!hasData);
        }
        if (exportBtn) {
            exportBtn.disabled = !hasData;
        }
    }

    var chartRegistry = {};

    function renderChart(canvasId, config) {
        var canvas = document.getElementById(canvasId);
        if (!canvas) { return null; }
        if (chartRegistry[canvasId]) {
            chartRegistry[canvasId].destroy();
        }
        var chart = new Chart(canvas, config);
        chartRegistry[canvasId] = chart;
        return chart;
    }

    function setupTabControls() {
        var container = document.querySelector('[data-dashboard-container]');
        if (!container) { return; }
        var activeTab = container.getAttribute('data-active-tab') || 'analytics';
        var buttons = container.querySelectorAll('[data-tab-trigger]');
        var panels = container.querySelectorAll('[data-tab-panel]');
        var forms = container.querySelectorAll('form[data-tab-aware-form]');

        function applyTab(tab) {
            activeTab = tab || 'analytics';
            container.setAttribute('data-active-tab', activeTab);
            buttons.forEach(function (btn) {
                var target = btn.getAttribute('data-tab-trigger');
                btn.classList.toggle('active', target === activeTab);
            });
            panels.forEach(function (panel) {
                var target = panel.getAttribute('data-tab-panel');
                panel.classList.toggle('is-active', target === activeTab);
            });
            forms.forEach(function (form) {
                var hidden = form.querySelector('input[name="tab"]');
                if (hidden) { hidden.value = activeTab; }
            });
        }

        buttons.forEach(function (btn) {
            btn.addEventListener('click', function () {
                var target = btn.getAttribute('data-tab-trigger');
                if (target && target !== activeTab) {
                    applyTab(target);
                }
            });
        });

        applyTab(activeTab);
    }

    function setupExportButtons() {
        document.querySelectorAll('.export-chart-btn').forEach(function (button) {
            button.addEventListener('click', function () {
                if (button.disabled) { return; }
                var target = button.getAttribute('data-chart-target');
                var chart = target && chartRegistry[target];
                if (!chart) { return; }
                var link = document.createElement('a');
                var timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.href = chart.toBase64Image();
                link.download = target + '-' + timestamp + '.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    }

    setupTabControls();

    var passRateContainer = document.getElementById('pass-rate-card');
    var passRateDataset = safeParse('pass-rate-data', []);
    var hasPassRate = Array.isArray(passRateDataset) && passRateDataset.length > 0;
    toggleEmptyState(passRateContainer, hasPassRate);
    if (hasPassRate) {
        renderChart('pass-rate-chart', {
            type: 'bar',
            data: {
                labels: passRateDataset.map(function (row) { return row.qualification || row.name || 'Qualification'; }),
                datasets: [{
                    label: 'Pass rate (%)',
                    data: passRateDataset.map(function (row) { return Number(row.pass_rate || row.value || 0); }),
                    backgroundColor: passRateDataset.map(function (_, idx) {
                        var palette = ['#3a063a', '#580658', '#8f6620', '#b8832a', '#403675'];
                        return palette[idx % palette.length];
                    }),
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: function (value) { return value + '%'; } }
                    }
                }
            }
        });
    }

    var completionContainer = document.getElementById('completion-card');
    var completionDataset = safeParse('completion-trend-data', []);
    var hasCompletion = Array.isArray(completionDataset) && completionDataset.length > 0;
    toggleEmptyState(completionContainer, hasCompletion);
    if (hasCompletion) {
        renderChart('completion-chart', {
            type: 'line',
            data: {
                labels: completionDataset.map(function (row) { return row.label || row.period || row.month || ''; }),
                datasets: [{
                    label: 'Assessments completed',
                    data: completionDataset.map(function (row) { return Number(row.completed || row.value || 0); }),
                    borderColor: '#3a063a',
                    backgroundColor: 'rgba(58, 6, 58, 0.12)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: '#3a063a'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    var typeContainer = document.getElementById('assessment-type-card');
    var typeDataset = safeParse('assessment-type-data', {});
    var typeEntries = [];
    if (typeDataset && typeof typeDataset === 'object') {
        Object.keys(typeDataset).forEach(function (key) {
            var val = Number(typeDataset[key]);
            if (!isNaN(val) && val > 0) {
                typeEntries.push({ label: key, value: val });
            }
        });
    }
    toggleEmptyState(typeContainer, typeEntries.length > 0);
    if (typeEntries.length > 0) {
        renderChart('assessment-type-chart', {
            type: 'doughnut',
            data: {
                labels: typeEntries.map(function (row) { return row.label; }),
                datasets: [{
                    data: typeEntries.map(function (row) { return row.value; }),
                    backgroundColor: ['#3a063a', '#8f6620', '#b8832a', '#403675', '#9478b8']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    var enrollmentContainer = document.getElementById('enrollment-card');
    var enrollmentDataset = safeParse('enrollment-data', []);
    var hasEnrollment = Array.isArray(enrollmentDataset) && enrollmentDataset.length > 0;
    toggleEmptyState(enrollmentContainer, hasEnrollment);
    if (hasEnrollment) {
        renderChart('enrollment-chart', {
            type: 'bar',
            data: {
                labels: enrollmentDataset.map(function (row) { return row.qualification || row.name || ''; }),
                datasets: [{
                    label: 'Learners',
                    data: enrollmentDataset.map(function (row) { return Number(row.learners || row.count || 0); }),
                    backgroundColor: '#580658',
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }

    var globalContainer = document.getElementById('global-comparison-card');
    var globalDataset = safeParse('global-compare-data', []);
    var hasGlobal = Array.isArray(globalDataset) && globalDataset.length > 0;
    toggleEmptyState(globalContainer, hasGlobal);
    if (hasGlobal) {
        var labels = globalDataset.map(function (row) { return row.label || ''; });
        renderChart('global-comparison-chart', {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'bar',
                        label: 'Learners',
                        data: globalDataset.map(function (row) { return Number(row.learners || 0); }),
                        backgroundColor: '#580658',
                        borderRadius: 8
                    },
                    {
                        type: 'bar',
                        label: 'Submissions',
                        data: globalDataset.map(function (row) { return Number(row.submissions || 0); }),
                        backgroundColor: '#b8832a',
                        borderRadius: 8
                    },
                    {
                        type: 'line',
                        label: 'Pass rate (%)',
                        data: globalDataset.map(function (row) { return Number(row.pass_rate || 0); }),
                        borderColor: '#3a063a',
                        backgroundColor: 'rgba(58, 6, 58, 0.15)',
                        yAxisID: 'y1',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        type: 'line',
                        label: 'Average score (%)',
                        data: globalDataset.map(function (row) { return Number(row.avg_score || 0); }),
                        borderColor: '#8f6620',
                        backgroundColor: 'rgba(143, 102, 32, 0.2)',
                        borderDash: [5, 4],
                        yAxisID: 'y1',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Learners / submissions' }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { callback: function (value) { return value + '%'; } },
                        title: { display: true, text: 'Performance (%)' }
                    }
                }
            }
        });
    }

    setupExportButtons();
})();
</script>
{% endblock %}
