{% load static %}
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ paper.title }}</title>
  {% now 'U' as ts %}
  <link rel="stylesheet" href="{% static 'core/exam_extractor/paper.css' %}?v={{ ts }}">
  <script defer src="{% static 'core/exam_extractor/lasso.js' %}?v={{ ts }}"></script>
</head>

<body class="paper-page">
  <div class="toolbar">
    <a href="{% url dashboard_url %}">&larr; Back to {{ dashboard_display_name }}</a>
    <button type="button" class="btn" id="btn-ai-draw" data-api="{% url 'exam_ai_draw_blocks' paper.id %}">Draw
      Blocks</button>
    <button type="button" class="btn btn-success" id="btn-actual-numbering">Actual Numbering</button>
    <button type="button" class="btn btn-danger" id="btn-capture-all">Capture All</button>
    <button type="button" class="btn btn-secondary" id="btn-ai-draw-auto"
      data-api="{% url 'exam_ai_draw_blocks' paper.id %}">Auto Draw All</button>
    <button type="button" class="btn btn-outline-secondary" id="btn-gadzira"
      data-api="{% url 'exam_gadzira_draw_blocks' paper.id %}">Gadzira</button>
    <form id="mbalaka-classify-form" method="post" action="{% url 'exam_mbalaka_classify' paper.id %}"
      style="display:inline-block; margin:0;">
      {% csrf_token %}
    </form>
  </div>



  <div class="layout">
    <div id="paper-container">
      {% for b in blocks %}
      {% if b.is_qheader %}
      <div class="q-header">
        Question {{ b.detected_qnum }}
        {% if b.detected_marks %}
        ({{ b.detected_marks }} marks)
        {% endif %}
      </div>
      {% endif %}
      <div class="block" data-id="{{ b.id }}" data-type="{{ b.block_type }}">
        {% with images=b.images.all %}
        {% if b.block_type == 'image' %}
        {% for img in images %}
        <img src="{{ img.image.url }}" class="block-image" alt="image {{ forloop.counter }}" />
        {% empty %}
        <div class="block-text">
          {{ b.rendered_html|default:b.text|safe }}
        </div>
        {% endfor %}
        {% elif b.block_type == 'table' %}
        <div class="block-table">
          {{ b.rendered_html|default:b.text|safe }}
        </div>
        {% else %}
        <div class="block-text">
          {{ b.rendered_html|default:b.text|safe }}
        </div>
        {% if images %}
        {% for img in images %}
        <img src="{{ img.image.url }}" class="block-image" alt="image {{ forloop.counter }}" />
        {% endfor %}
        {% endif %}
        {% endif %}
        {% endwith %}
      </div>
      {% endfor %}

      <!-- Selection overlay lives here -->
      <div id="lasso-overlay"></div>
      <!-- Saved highlights (question_header boxes) -->
      <div id="saved-overlay"></div>
    </div>

    <aside class="sidebar">
      <h3>Paper Meta</h3>
      <form id="paper-meta-form" method="post" action="{% url 'exam_save_paper_meta' paper.id %}"
        style="margin-bottom:1rem;">
        {% csrf_token %}
        <label>Module Name</label>
        <select name="module_name" required>
          <option value="">Select qualification…</option>
          {% for qual in qualifications %}
          <option value="{{ qual.name }}" {% if paper.module_name == qual.name %}selected{% endif %}>{{ qual.name }}
          </option>
          {% endfor %}
        </select>
        <div class="meta-grid">
          <div>
            <label>Set Number</label>
            <select name="paper_number" id="paper-number" data-current="{{ paper.paper_number }}">
              <option value="">Select number</option>
            </select>
          </div>
          <div>
            <label>Set Letter</label>
            <select name="paper_letter" id="paper-letter" data-current="{{ paper.paper_letter }}">
              <option value="">Select letter</option>
            </select>
          </div>
        </div>
        <input type="hidden" name="title" id="paper-title" value="{{ paper.title }}" />
        <div style="display:flex; justify-content:flex-end;">
          <button type="submit" class="btn">Save Meta</button>
        </div>
      </form>
      <h3 style="display:none;">AI Settings</h3>
      <form method="post" action="{% url 'exam_save_system_prompt' paper.id %}" style="display:none;">
        {% csrf_token %}
        <textarea name="system_prompt" rows="5" placeholder="System prompt per paper..."
          style="width:100%; padding:.4rem;">{{ paper.system_prompt }}</textarea>
        <div style="display:flex; justify-content:flex-end;">
          <button type="submit" class="btn">Save Prompt</button>
        </div>
      </form>
      <h3>Saved Boxes</h3>
      <ul id="boxes-list" class="boxes">
        {% for bx in boxes %}
        <details class="box-item" data-id="{{ bx.id }}" data-x="{{ bx.x }}" data-y="{{ bx.y }}" data-w="{{ bx.w }}"
          data-h="{{ bx.h }}" data-qn="{{ bx.question_number|default:'' }}"
          data-parent-number="{{ bx.parent_number|default:'' }}" data-header-label="{{ bx.header_label|default:'' }}"
          data-case-label="{{ bx.case_study_label|default:'' }}" data-marks="{{ bx.marks|default:'' }}"
          data-qtype="{{ bx.qtype|default:'' }}" data-update-url="{% url 'exam_update_box' paper.id bx.id %}"
          data-delete-url="{% url 'exam_delete_box' paper.id bx.id %}"
          data-json-url="{% url 'exam_get_box' paper.id bx.id %}" data-ctype="{{ bx.content_type }}"
          data-content="{{ bx.content|default:''|escapejs }}" data-created-at="{{ bx.created_at|date:'c' }}">
          <summary>
            <span class="title">{{ bx.display_qtype }}</span>
            <span class="kv">
              Q: {{ bx.question_number|default:"n/a" }}
              {% if bx.parent_number %}&bull; Parent: {{ bx.parent_number }}{% endif %}
              &bull; Marks: {{ bx.marks|default:"n/a" }}
            </span>
            <span class="actions">
              <button type="button" class="btn-icon view-content" title="View captured content"
                aria-label="View content">Content</button>
              <!-- <button type="button" class="btn-icon view-snapshot" title="View snapshot"
                aria-label="View snapshot">Snap</button> -->
              <!-- <button type="button" class="btn-icon edit-box" title="Edit this box" aria-label="Edit">Edit</button> -->
              <!-- <button type="button" class="btn-icon resize-box" title="Resize this box"
                aria-label="Resize">Resize</button> -->
              <button type="button" class="btn-icon delete-box" title="Delete this box"
                aria-label="Delete">Delete</button>
              <span class="chev">?</span>
            </span>
          </summary>
          <div class="box-meta">
            <div class="kv">x={{ bx.x|floatformat:0 }}, y={{ bx.y|floatformat:0 }}, w={{ bx.w|floatformat:0 }}, h={{
              bx.h|floatformat:0 }}</div>
            {% if bx.parent_number %}<div class="kv">Parent: {{ bx.parent_number }}</div>{% endif %}
            {% if bx.header_label %}<div class="kv">Header: {{ bx.header_label }}</div>{% endif %}
            {% if bx.case_study_label %}<div class="kv">Case study: {{ bx.case_study_label }}</div>{% endif %}
            <div class="kv">{{ bx.created_at|date:"M j, Y, H:i" }}</div>
          </div>
        </details>
        {% empty %}
        <li class="box-item">No boxes yet. Draw a rectangle on the page to add one.</li>
        {% endfor %}
      </ul>
    </aside>
  </div>

  <!-- Save modal -->
  <div id="meta-modal" class="modal hidden">
    <form id="meta-form" method="post" action="{% url 'exam_create_box' paper.id %}">
      {% csrf_token %}
      <input type="hidden" name="x" />
      <input type="hidden" name="y" />
      <input type="hidden" name="w" />
      <input type="hidden" name="h" />
      <input type="hidden" name="content_json" />
      <input type="hidden" name="content_type" />
      <label for="question_number">Question #</label>
      <input id="question_number" name="question_number" placeholder="e.g., 1.1" required />

      <label for="marks">Marks</label>
      <input id="marks" name="marks" placeholder="e.g., 10" required />

      <label for="qtype">Type</label>
      <select id="qtype" name="qtype" title="Select type">
        <option value="question" selected>Question</option>
        <option value="question_part">Question Part</option>
        <option value="heading">Heading</option>
        <option value="case_study">Case Study</option>
        <option value="instruction">Instruction</option>
        <option value="cover_page">Cover Page</option>
      </select>

      <label for="parent_number">Parent #</label>
      <input id="parent_number" name="parent_number" placeholder="e.g., 1.1" />

      <label for="header_label" class="conditional-field" data-visible="heading">Header title</label>
      <input id="header_label" name="header_label" placeholder="Heading text" class="conditional-field"
        data-visible="heading" />

      <label for="case_study_label" class="conditional-field" data-visible="case_study">Case study title</label>
      <input id="case_study_label" name="case_study_label" placeholder="Case study title" class="conditional-field"
        data-visible="case_study" />
      <div class="modal-actions">
        <button type="submit">Save Box</button>
        <button type="button" id="cancel-meta" aria-label="Close metadata dialog">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Snapshot Preview Modal -->
  <div id="preview-modal" class="modal">
    <div class="preview-card" role="dialog" aria-modal="true" aria-labelledby="preview-title">
      <div class="preview-header">
        <strong id="preview-title">Snapshot Preview</strong>
        <button type="button" class="btn-icon" id="preview-close" aria-label="Close">?</button>
      </div>
      <div class="preview-body">
        <div id="preview-viewport">
          <div id="preview-scene"></div>
        </div>
      </div>
      <div class="preview-actions">
        <!-- <button type="button" class="btn-icon" id="preview-zoom-out" title="Zoom out">-</button>
        <button type="button" class="btn-icon" id="preview-zoom-in" title="Zoom in">+</button> -->
      </div>
    </div>
  </div>

  <!-- Captured Content Modal -->
  <div id="content-modal" class="modal hidden">
    <div class="preview-card" role="dialog" aria-modal="true" aria-labelledby="content-title">
      <div class="preview-header">
        <strong id="content-title">Captured Content</strong>
        <button type="button" class="btn-icon" id="content-close" aria-label="Close">?</button>
      </div>
      <div class="preview-body" id="content-body"></div>
      <div class="preview-actions">
        <button type="button" class="btn-icon" id="content-ok">Close</button>
      </div>
    </div>
  </div>

  <!-- Question Bank Modal -->
  <div id="bank-modal" class="modal hidden">
    <div class="preview-card" role="dialog" aria-modal="true" aria-labelledby="bank-title">
      <div class="preview-header">
        <strong id="bank-title">Question Bank</strong>
        <button type="button" class="btn-icon" id="bank-close" aria-label="Close">?</button>
      </div>
      <div class="preview-body">
        <div style="display:grid; gap:.5rem;">
          <label for="bank-module">Module</label>
          <select id="bank-module"></select>
          <div id="bank-counts" style="font-size:.9rem; color:#374151;"></div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-top:.5rem;">
            <div>
              <strong>Base (this paper)</strong>
              <div id="bank-base" class="boxes"
                style="border:1px solid #e5e7eb; border-radius:.4rem; padding:.5rem; max-height:250px; overflow:auto;">
              </div>
            </div>
            <div>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>Preview (randomized)</strong>
                <button type="button" class="btn-icon" id="bank-regenerate">Regenerate</button>
              </div>
              <div id="bank-preview" class="boxes"
                style="border:1px solid #e5e7eb; border-radius:.4rem; padding:.5rem; max-height:250px; overflow:auto;">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="preview-actions">
        <button type="button" class="btn-icon" id="bank-build">Build Randomized Test</button>
      </div>
    </div>
  </div>
  <script>
    (function () {
      const btn = document.getElementById('btn-bank');
      const modal = document.getElementById('bank-modal');
      const sel = document.getElementById('bank-module');
      const countsDiv = document.getElementById('bank-counts');
      const infoUrl = btn?.getAttribute('data-info');
      const previewUrl = '{% url "exam_bank_preview" paper.id %}';
      const randUrl = btn?.getAttribute('data-rand');
      const close = document.getElementById('bank-close');
      const baseDiv = document.getElementById('bank-base');
      const prevDiv = document.getElementById('bank-preview');
      const regenBtn = document.getElementById('bank-regenerate');
      function open() { modal.classList.remove('hidden'); }
      function closeM() { modal.classList.add('hidden'); }
      function renderContent(el, payload) {
        el.innerHTML = '';
        (payload.items || []).forEach(item => {
          if (item.type === 'text') {
            const p = document.createElement('p');
            p.textContent = item.text || '';
            el.appendChild(p);
          } else if (item.type === 'table') {
            const d = document.createElement('div');
            d.className = 'block-table';
            d.innerHTML = item.html || '';
            el.appendChild(d);
          } else if (item.type === 'image') {
            (item.images || []).forEach(src => {
              const i = document.createElement('img');
              i.src = src;
              i.className = 'block-image';
              el.appendChild(i);
            });
          }
        });
      }
      function card(title, sub, payload) {
        const wrap = document.createElement('div');
        wrap.style.border = '1px solid #e5e7eb'; wrap.style.borderRadius = '.35rem'; wrap.style.padding = '.4rem .5rem'; wrap.style.margin = '.35rem 0';
        const h = document.createElement('div'); h.innerHTML = `<strong>${title}</strong> <span style="color:#6b7280; font-size:.85rem;">${sub || ''}</span>`; wrap.appendChild(h);
        const body = document.createElement('div'); wrap.appendChild(body);
        try { renderContent(body, payload); } catch (_) { }
        return wrap;
      }
      async function loadModules() {
        const r = await fetch(infoUrl, { credentials: 'same-origin' });
        const j = await r.json();
        sel.innerHTML = '';
        (j.modules || []).forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o); });
        // render base list
        baseDiv.innerHTML = '';
        (j.base || []).forEach(b => {
          let payload = {};
          try { payload = JSON.parse(b.content || '{}'); } catch (_) { }
          baseDiv.appendChild(card(`Q ${b.question_number}`, b.marks ? `(${b.marks} marks)` : '', payload));
        });
        if (sel.value) { loadCounts(sel.value); await regenerate(); }
      }
      async function loadCounts(mod) {
        const u = infoUrl + `?module=${encodeURIComponent(mod)}`;
        const r = await fetch(u, { credentials: 'same-origin' });
        const j = await r.json();
        const entries = Object.entries(j.counts || {}).sort((a, b) => a[0].localeCompare(b[0]));
        countsDiv.innerHTML = entries.map(([q, c]) => `${q || '(blank)'}: ${c}`).join(' · ');
      }
      async function regenerate() {
        prevDiv.innerHTML = '';
        const u = previewUrl + `?module_name=${encodeURIComponent(sel.value)}`;
        const r = await fetch(u, { credentials: 'same-origin' });
        const j = await r.json();
        (j.items || []).forEach(b => {
          let payload = {};
          try { payload = JSON.parse(b.content || '{}'); } catch (_) { }
          const el = card(`Q ${b.question_number}`, b.marks ? `(${b.marks} marks)` : '', payload);
          el.dataset.boxId = String(b.box_id);
          prevDiv.appendChild(el);
        });
      }
      sel?.addEventListener('change', () => loadCounts(sel.value));
      btn?.addEventListener('click', () => { open(); loadModules(); });
      close?.addEventListener('click', closeM);
      regenBtn?.addEventListener('click', regenerate);
      document.getElementById('bank-build')?.addEventListener('click', async () => {
        if (!sel.value) return alert('Select a module');
        const fd = new FormData();
        fd.append('module_name', sel.value);
        // include previewed picks (if present) to persist exactly what is shown
        const ids = Array.from(prevDiv.querySelectorAll('[data-box-id]')).map(n => n.dataset.boxId).filter(Boolean);
        if (ids.length) fd.append('box_ids', ids.join(','));
        const csrf = document.querySelector('input[name=csrfmiddlewaretoken]')?.value;
        const r = await fetch(randUrl, { method: 'POST', body: fd, credentials: 'same-origin', headers: csrf ? { 'X-CSRFToken': csrf } : {} });
        if (!r.ok) return alert('Failed to build test');
        const j = await r.json();
        if (j && (j.test_url || j.test_id)) {
          window.location.href = j.test_url || (`/test/${j.test_id}/`);
        }
      });
    })();
  </script>
  <script type="application/json" id="module-catalog">{{ module_catalog_json|safe }}</script>
  <script>
    (function () {
      const catalogEl = document.getElementById('module-catalog');
      const metaForm = document.querySelector('form[action="{% url 'exam_save_paper_meta' paper.id %}"]');
      if (!catalogEl || !metaForm) {
        return;
      }

      const moduleSelect = metaForm.querySelector('select[name="module_name"]');
      const numberSelect = metaForm.querySelector('select[name="paper_number"]');
      const letterSelect = metaForm.querySelector('select[name="paper_letter"]');
      const titleInput = metaForm.querySelector('input[name="title"]');

      if (!moduleSelect || !numberSelect || !letterSelect || !titleInput) {
        return;
      }

      let catalog = {};
      try {
        catalog = JSON.parse(catalogEl.textContent || '{}');
      } catch (err) {
        console.warn('Unable to parse module catalog', err);
        catalog = {};
      }

      const normalize = (value) => (value ?? '').toString().trim();
      const parseCode = (code) => {
        const normalized = normalize(code);
        if (!normalized) {
          return { number: '', suffix: '' };
        }
        const match = normalized.match(/^(\d+)(.*)$/);
        return {
          number: match ? match[1] : '',
          suffix: match ? normalize(match[2]) : '',
        };
      };

      const defaultPaperNumbers = Array.from({ length: 20 }, (_, idx) => String(idx + 1));

      const allModules = Object.values(catalog).reduce((acc, entry) => {
        if (Array.isArray(entry)) {
          entry.forEach(mod => acc.push(mod));
        }
        return acc;
      }, []);

      const initialNumber = normalize(numberSelect.dataset.current || numberSelect.value);
      const initialLetter = normalize(letterSelect.dataset.current || letterSelect.value);

      const modulesForSelection = () => {
        const selectedName = normalize(moduleSelect.value);
        const scoped = catalog[selectedName];
        if (Array.isArray(scoped) && scoped.length) {
          return scoped;
        }
        return allModules;
      };

      const rebuildNumberOptions = () => {
        const previous = normalize(numberSelect.value) || initialNumber;
        const modules = modulesForSelection();
        const set = new Map();
        modules.forEach(mod => {
          const numberPart = parseCode(mod.code).number;
          if (numberPart) {
            set.set(numberPart, true);
          }
        });
        if (initialNumber && !set.has(initialNumber)) {
          set.set(initialNumber, true);
        }
        if (!set.size) {
          defaultPaperNumbers.forEach(num => set.set(num, true));
        }
        const ordered = Array.from(set.keys())
          .filter(Boolean)
          .sort((a, b) => (Number(a) - Number(b)) || a.localeCompare(b));

        numberSelect.innerHTML = '<option value="">Select number</option>';
        ordered.forEach(num => {
          const opt = document.createElement('option');
          opt.value = num;
          opt.textContent = num;
          if (previous && previous === num) {
            opt.selected = true;
          }
          numberSelect.appendChild(opt);
        });
        if (!numberSelect.value && ordered.length === 1) {
          numberSelect.value = ordered[0];
        }
      };

      const rebuildLetterOptions = () => {
        const previous = normalize(letterSelect.value) || initialLetter;
        const selectedNumber = normalize(numberSelect.value) || initialNumber;
        const modules = modulesForSelection().filter(mod => {
          if (!selectedNumber) {
            return true;
          }
          return parseCode(mod.code).number === selectedNumber;
        });

        const entries = new Map();
        modules.forEach(mod => {
          const code = normalize(mod.code);
          if (!code) {
            return;
          }
          const parts = parseCode(code);
          const suffix = parts.suffix || code.replace(/^[0-9]+/, '') || code;
          entries.set(code, suffix);
        });
        if (initialLetter && !entries.has(initialLetter)) {
          const parts = parseCode(initialLetter);
          const suffix = parts.suffix || initialLetter.replace(/^[0-9]+/, '') || initialLetter;
          entries.set(initialLetter, suffix);
        }

        const defaultLetters = ['A', 'B', 'C', 'D'];
        if (selectedNumber) {
          defaultLetters.forEach(letter => {
            const code = `${selectedNumber}${letter}`;
            if (!entries.has(code)) {
              entries.set(code, letter);
            }
          });
        } else {
          defaultLetters.forEach(letter => {
            if (!entries.has(letter)) {
              entries.set(letter, letter);
            }
          });
        }

        letterSelect.innerHTML = '<option value="">Select letter</option>';
        entries.forEach((label, code) => {
          const opt = document.createElement('option');
          opt.dataset.code = code;
          opt.value = label || code;
          opt.textContent = label || code;
          if (previous && (previous === code || previous === opt.value)) {
            opt.selected = true;
          }
          letterSelect.appendChild(opt);
        });

        if (!letterSelect.value && letterSelect.options.length === 2) {
          letterSelect.selectedIndex = 1;
        }
      };

      const computeTitle = () => {
        const moduleText = normalize(moduleSelect.options[moduleSelect.selectedIndex]?.text || moduleSelect.value);
        const numberValue = normalize(numberSelect.value);
        const letterValue = normalize(letterSelect.value);
        const selectedLetterOption = letterSelect.options[letterSelect.selectedIndex];
        const letterCodeFull = normalize(selectedLetterOption?.dataset.code || (numberValue ? `${numberValue}${letterValue}` : letterValue));

        let suffix = '';
        if (numberValue || letterCodeFull) {
          const parts = parseCode(letterCodeFull);
          const letterSuffix = parts.suffix || (letterCodeFull.replace(new RegExp(`^${numberValue}`), '') || letterValue || '');
          suffix = `${numberValue}${letterSuffix}`.trim();
        }

        const segments = [];
        if (moduleText) {
          segments.push(moduleText);
        }
        if (suffix) {
          segments.push(suffix);
        }

        titleInput.value = segments.join(' ').trim();
      };

      rebuildNumberOptions();
      rebuildLetterOptions();
      computeTitle();

      moduleSelect.addEventListener('change', () => {
        rebuildNumberOptions();
        rebuildLetterOptions();
        computeTitle();
      });
      numberSelect.addEventListener('change', () => {
        rebuildLetterOptions();
        computeTitle();
      });
      letterSelect.addEventListener('change', computeTitle);
    })();
  </script>
  <script>
    (() => {
      const container = document.getElementById('paper-container');
      if (!container) {
        return;
      }
      const numberingBtn = document.getElementById('btn-actual-numbering');
      const captureAllBtn = document.getElementById('btn-capture-all');

      const RE_SPACE = /\u00a0/g;

      const MARK_ONLY_RE = /^\(?\s*\d+(?:\.\d+)*\s*(?:mark|marks)\b[\s\)\.:;-]*$/i;
      const NUMBER_PREFIX_RE = /^(?:question|q|item)\b[\s\.,:)\-]*/i;

      const extractNumberFromText = (text) => {
        if (!text) {
          return null;
        }
        const normalized = text.replace(RE_SPACE, ' ').trim();
        if (MARK_ONLY_RE.test(normalized)) {
          return null;
        }
        const trimmed = normalized.replace(NUMBER_PREFIX_RE, '').trim();
        const match = trimmed.match(/^(\d+(?:\.\d+)*)/);
        return match && match[1] ? match[1].trim() : null;
      };

      const normalizeNumbering = (num) => {
        if (!num) {
          return null;
        }
        const parts = num.split('.');
        if (parts.length === 2) {
          const [major, minor] = parts;
          if (minor.length >= 2) {
            const secondPart = minor.slice(0, -1);
            const thirdPart = minor.slice(-1);
            if (/^\d+$/.test(secondPart) && /^\d+$/.test(thirdPart)) {
              return `${major}.${secondPart}.${thirdPart}`;
            }
          }
        }
        return num;
      };

      const getParentNumber = (num) => {
        if (!num) {
          return null;
        }
        const parts = num.split('.');
        return parts.length > 1 ? parts.slice(0, -1).join('.') : null;
      };

      const extractMarks = (text) => {
        if (!text) {
          return '';
        }
        const normalized = text.replace(RE_SPACE, ' ');
        const markMatch = normalized.match(/(\d{1,4})\s*(?:mark|marks)\b/i);
        if (markMatch) {
          return markMatch[1];
        }
        const totalMatch = normalized.match(/\btotal(?:\s+marks?)?\s*(?:[:=\-])?\s*(\d{1,4})\b/i);
        if (totalMatch) {
          return totalMatch[1];
        }
        return '';
      };

      const analyzeBlocks = () => {
        const blocks = Array.from(container.querySelectorAll('.block'));
        const infoById = {};
        const elementById = {};
        const numberToBlockId = {};
        const trailing = {};
        const numbersOrdered = [];
        let lastNumberedId = null;

        blocks.forEach((block, index) => {
          const blockId = block.dataset.id || `block-${index}`;
          block.dataset.id = blockId;
          elementById[blockId] = block;
          const blockText = (block.textContent || '').trim();
          const rawNum = extractNumberFromText(blockText);
          if (rawNum) {
            const normalized = normalizeNumbering(rawNum);
            block.dataset.qn = normalized;
            const parentNumber = getParentNumber(normalized);
            infoById[blockId] = {
              number: normalized,
              raw: rawNum,
              level: normalized.split('.').length,
              text: blockText,
              parentNumber,
              parentId: null,
              children: [],
            };
            if (!numberToBlockId[normalized]) {
              numberToBlockId[normalized] = blockId;
            }
            numbersOrdered.push(blockId);
            lastNumberedId = blockId;
          } else if (lastNumberedId) {
            if (!trailing[lastNumberedId]) {
              trailing[lastNumberedId] = [];
            }
            trailing[lastNumberedId].push(blockId);
          }
        });

        Object.entries(infoById).forEach(([blockId, meta]) => {
          const parentBlockId = meta.parentNumber ? numberToBlockId[meta.parentNumber] : null;
          if (parentBlockId && infoById[parentBlockId]) {
            meta.parentId = parentBlockId;
            infoById[parentBlockId].children.push(blockId);
          } else {
            meta.parentId = null;
          }
        });

        return { blocks, infoById, trailing, numbersOrdered, elementsById: elementById };
      };

      const collectSubtreeIds = (rootId, meta) => {
        const ids = new Set();
        const visit = (id) => {
          if (!id || ids.has(id)) {
            return;
          }
          ids.add(id);
          const trailingIds = meta.trailing[id];
          if (trailingIds) {
            trailingIds.forEach((tid) => ids.add(tid));
          }
          const children = meta.infoById[id]?.children || [];
          children.forEach(visit);
        };
        visit(rootId);
        if (!ids.size) {
          return [];
        }
        const ordered = [];
        meta.blocks.forEach((block) => {
          const id = block.dataset.id;
          if (ids.has(id)) {
            ordered.push(id);
          }
        });
        return ordered;
      };

      const getBlockAndTrailingText = (blockId, meta) => {
        const el = meta.elementsById[blockId];
        if (!el) {
          return '';
        }
        let text = el.textContent || '';
        const trailingIds = meta.trailing[blockId] || [];
        trailingIds.forEach((tid) => {
          const trailingEl = meta.elementsById[tid];
          if (trailingEl) {
            text += ` ${(trailingEl.textContent || '')}`;
          }
        });
        return text;
      };

      const getMarksFromTables = (elements) => {
        const nodes = Array.isArray(elements) ? elements : [elements];
        for (const node of nodes) {
          if (!node) continue;
          const tables = node.querySelectorAll('table');
          for (const table of tables) {
            const rows = Array.from(table.querySelectorAll('tr'));
            for (let r = rows.length - 1; r >= 0; r -= 1) {
              const cells = Array.from(rows[r].querySelectorAll('th,td'));
              if (!cells.length) {
                continue;
              }
              const totalCellIndex = cells.findIndex((cell) =>
                /total/i.test((cell.textContent || '').trim())
              );
              if (totalCellIndex === -1) {
                continue;
              }
              const labelCell = cells[totalCellIndex];
              const labelText = (labelCell.textContent || '').replace(/total/i, '').trim();
              const inlineMatch = labelText.match(/(\d{1,4})(?:\s*(?:mark|marks))?/i);
              if (inlineMatch) {
                return inlineMatch[1];
              }
              for (let c = cells.length - 1; c >= 0; c -= 1) {
                if (c === totalCellIndex) continue;
                const cellText = (cells[c].textContent || '').replace(RE_SPACE, ' ').trim();
                const numericMatch = cellText.match(/(\d{1,4})(?:\s*(?:mark|marks))?/i);
                if (numericMatch) {
                  return numericMatch[1];
                }
              }
            }
          }
        }
        return '';
      };

      const getMarksForBlock = (blockId, meta) => {
        const el = meta.elementsById[blockId];
        if (!el) {
          return '';
        }
        const attrMarks = (el.dataset.marks || '').trim();
        if (attrMarks) {
          return attrMarks;
        }
        const nodes = [el];
        const trailingIds = meta.trailing[blockId] || [];
        trailingIds.forEach((tid) => {
          const node = meta.elementsById[tid];
          if (node) {
            nodes.push(node);
          }
        });
        const combinedText = nodes.map((node) => node.textContent || '').join(' ');
        const textMarks = extractMarks(combinedText);
        if (textMarks) {
          return textMarks;
        }
        const tableMarks = getMarksFromTables(nodes);
        if (tableMarks) {
          return tableMarks;
        }
        return '';
      };

      const buildSuggestions = (meta) => {
        const suggestions = [];
        meta.numbersOrdered.forEach((blockId) => {
          const info = meta.infoById[blockId];
          if (!info) {
            return;
          }
          const childCount = info.children?.length || 0;
          if (childCount > 0) {
            return;
          }
          const blockIds = collectSubtreeIds(blockId, meta);
          if (!blockIds.length) {
            return;
          }
          const parentNumber = info.parentId
            ? meta.infoById[info.parentId]?.number || info.parentNumber || ''
            : info.parentNumber || '';
          suggestions.push({
            block_ids: blockIds,
            question_number: info.number,
            parent_number: parentNumber,
            marks: getMarksForBlock(blockId, meta),
            qtype: 'question',
          });
        });
        return suggestions;
      };

      const queueNumberingRun = (autoMode = false) => {
        console.log(`[Numbering] Starting scan for numbered blocks...${autoMode ? ' (auto)' : ''}`);
        const meta = analyzeBlocks();
        if (!meta.numbersOrdered.length) {
          alert('No numbered blocks detected in this document.');
          return false;
        }
        const suggestions = buildSuggestions(meta);
        if (!suggestions.length) {
          alert('Numbering found, but no drawable segments could be created.');
          return false;
        }
        const options = { label: autoMode ? 'Capture All' : 'Numbering' };
        if (autoMode) {
          options.auto = true;
        }
        const queued = window.examExtractorQueueSuggestions
          ? window.examExtractorQueueSuggestions(suggestions, options)
          : false;
        if (!queued) {
          console.warn('Numbering suggestions ready:', suggestions);
          alert('Segments prepared, but drawing queue is unavailable.');
          return false;
        }
        return true;
      };

      numberingBtn?.addEventListener('click', () => {
        queueNumberingRun(false);
      });

      const resetCaptureAllButton = () => {
        if (!captureAllBtn) return;
        captureAllBtn.disabled = false;
        captureAllBtn.textContent = captureAllBtn.dataset.originalLabel || 'Capture All';
        delete captureAllBtn.dataset.state;
      };

      captureAllBtn?.addEventListener('click', () => {
        if (captureAllBtn.dataset.state === 'run') {
          return;
        }
        captureAllBtn.dataset.originalLabel =
          captureAllBtn.dataset.originalLabel || captureAllBtn.textContent?.trim() || 'Capture All';
        captureAllBtn.disabled = true;
        captureAllBtn.dataset.state = 'run';
        captureAllBtn.textContent = 'Capturing...';
        const queued = queueNumberingRun(true);
        if (!queued) {
          resetCaptureAllButton();
          return;
        }
        window.__captureAllActive = true;
      });

      window.addEventListener('capture-all-finished', () => {
        resetCaptureAllButton();
      });
    })();
  </script>


</body>

</html>
