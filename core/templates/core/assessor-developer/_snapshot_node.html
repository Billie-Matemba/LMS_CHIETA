{% load exam_extras %}
{% with memo=node_memos|dict_get:node.id node_type_lower=node.node_type|default:''|lower cover_fallback=cover_box_content|dict_get:node.id %}
<div class="snapshot-node snapshot-node--{{ node.node_type }}{% if memo %} snapshot-node--has-memo{% endif %}"
     data-node-id="{{ node.id }}"
     data-node-type="{{ node.node_type }}"
     data-node-content="{{ node.content_json|default:'[]'|escape }}">
  <div class="snapshot-node__header">
    <div class="snapshot-node__label">
      {% if node.node_type %}<span class="snapshot-node__type-badge">{{ node.node_type|title }}</span>{% endif %}
      {% if node.number %}<span class="snapshot-node__number">#{{ node.number }}</span>{% endif %}
      {% if node.parent_number %}<span class="snapshot-node__parent">Parent {{ node.parent_number }}</span>{% endif %}
      {% if node.id %}<span class="snapshot-node__meta">Node {{ node.id }}</span>{% endif %}
    </div>
    <div class="snapshot-node__controls">
      {% if node.marks %}<span class="snapshot-node__marks">{{ node.marks }} marks</span>{% endif %}
      <div class="snapshot-node__actions">
        <form method="post" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="node_id" value="{{ node.id }}">
          <button type="submit" name="action" value="delete_node" class="btn btn-sm btn-outline-danger">Delete</button>
        </form>
        {% if node_type_lower != 'cover_page' and node.node_type != 'instruction' %}
          <form method="post" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="node_id" value="{{ node.id }}">
            <input type="hidden" name="target_type" value="instruction">
            <button type="submit" name="action" value="convert_node" class="btn btn-sm btn-outline-secondary">Mark Instruction</button>
          </form>
        {% elif node_type_lower != 'cover_page' and node.node_type != 'question' %}
          <form method="post" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="node_id" value="{{ node.id }}">
            <input type="hidden" name="target_type" value="question">
            <button type="submit" name="action" value="convert_node" class="btn btn-sm btn-outline-secondary">Mark Question</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  {% if node.text %}
    {% if node_type_lower == 'cover_page' %}
      <div class="snapshot-node__text">
        {{ node.text|safe }}
      </div>
    {% else %}
      <div class="snapshot-node__text editable-block"
           contenteditable="true"
           data-editable="true"
           data-text-block="true">
        {{ node.text }}
      </div>
    {% endif %}
  {% endif %}

  {% with display_blocks=node.content|default:cover_fallback %}
  {% if display_blocks %}
    <div class="snapshot-node__content" data-node-content-list>
      {% for block in display_blocks %}
        {% if node_type_lower == 'cover_page' %}
          <div class="editable-block"
               contenteditable="false"
               data-editable="false"
               data-block-index="{{ forloop.counter0 }}"
               data-block-type="{{ block.type|default_if_none:'text' }}">
            {% if block.type == 'text' %}
              {{ block.text|default_if_none:''|safe }}
            {% else %}
              {{ block|render_block }}
            {% endif %}
          </div>
        {% else %}
          {% with editable=block|is_text_block %}
          <div class="editable-block"
               contenteditable="{{ editable|yesno:'true,false' }}"
               data-editable="{{ editable|yesno:'true,false' }}"
               data-block-index="{{ forloop.counter0 }}"
               data-block-type="{{ block.type|default_if_none:'text' }}">
            {{ block|render_block }}
          </div>
          {% endwith %}
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
  {% endwith %}

  {% if node.children %}
    <div class="snapshot-node__children">
      {% for child in node.children %}
        {% include 'core/assessor-developer/_snapshot_node.html' with node=child %}
      {% endfor %}
    </div>
  {% endif %}
  {% if node_type_lower != 'cover_page' %}
    <form method="post" class="snapshot-node__editor" data-node-form>
      {% csrf_token %}
      <input type="hidden" name="node_id" value="{{ node.id }}">
      <input type="hidden" name="node_content_json" data-field="node-content" value="{{ node.content_json|default:'[]'|escape }}">
      <input type="hidden" name="node_text" data-field="node-text" value="{{ node.text|default_if_none:''|escape }}">
      <input type="hidden" name="editor_mode" data-field="editor-mode" value="paper">
      <input type="hidden" name="raw_mode" data-field="raw-mode" value="off">
      <input type="hidden" name="action" value="">
      <div class="row g-2 align-items-end">
        <div class="col-sm-4">
          <label class="form-label small text-muted mb-1">Number</label>
          <input type="text" name="node_number" class="form-control form-control-sm" value="{{ node.number }}">
        </div>
        <div class="col-sm-4">
          <label class="form-label small text-muted mb-1">Marks</label>
          <input type="text" name="node_marks" class="form-control form-control-sm" value="{{ node.marks }}">
        </div>
      </div>
      <div class="mt-2" data-memo-input>
        <label class="form-label small text-muted mb-1">Memo / Answer content</label>
        <textarea name="memo_text" class="form-control form-control-sm memo-input" rows="2" placeholder="Type the corresponding memo here...">{{ memo.content|default_if_none:'' }}</textarea>
      </div>
      <div class="mt-2 text-muted small" data-memo-mode-note>
        In memo mode the system uses the current block as the memo, but you can also type or paste the answer here if the block is blank.
      </div>
      <div class="mt-2">
        <label class="form-label small text-muted mb-1">Notes (optional)</label>
        <input type="text" name="memo_notes" class="form-control form-control-sm" value="{{ memo.notes|default_if_none:'' }}">
      </div>
      <div class="mt-3 d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-sm btn-primary" data-role="save-node" data-submit-action="save_node_content">
          Save Block
        </button>
      <!--
      <button type="button" class="btn btn-sm btn-success" data-role="add-memo" data-submit-action="add_corresponding_memo">
        Add Corresponding
      </button>
      -->
        <button type="button" class="btn btn-sm btn-outline-info" data-role="toggle-raw">
          Full Block Editor
        </button>
      </div>
    </form>
  {% endif %}
</div>
{% endwith %}
