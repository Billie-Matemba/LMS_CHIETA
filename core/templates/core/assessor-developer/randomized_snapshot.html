{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Randomized Paper | {{ assessment.eisa_id }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f5f5f8;
      font-family: "Inter", system-ui, sans-serif;
    }

    .snapshot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .snapshot-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 6px rgba(15, 23, 42, 0.08);
      padding: 20px;
      margin-bottom: 18px;
    }

    .snapshot-node {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 12px;
      background: #fff;
    }

    .snapshot-node__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .snapshot-node__label {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .4rem;
    }

    .snapshot-node__type-badge {
      display: inline-flex;
      align-items: center;
      background: rgba(79, 70, 229, 0.12);
      color: #312e81;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      text-transform: capitalize;
    }

    .snapshot-node__number {
      font-weight: 700;
      color: #4b0082;
      font-size: 0.95rem;
    }

    .snapshot-node__parent {
      font-size: 0.85rem;
      color: #475569;
    }

    .snapshot-node__marks {
      font-size: 0.85rem;
      color: #0f172a;
      background: rgba(79, 70, 229, 0.08);
      border-radius: 999px;
      padding: 2px 10px;
      margin-left: 8px;
    }

    .snapshot-node__text {
      margin-bottom: 10px;
      color: #1f2937;
      white-space: pre-wrap;
    }

    .snapshot-node__children {
      border-left: 2px solid rgba(79, 70, 229, 0.25);
      margin-left: 14px;
      padding-left: 14px;
    }

    .snapshot-node__images {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .snapshot-node__controls {
      display: flex;
      align-items: flex-start;
      gap: .5rem;
    }

    .snapshot-node__actions {
      display: flex;
      flex-wrap: wrap;
      gap: .3rem;
    }

    .snapshot-node__actions form {
      display: inline;
    }

    .snapshot-node__image {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }

    .snapshot-node--heading {
      background: #f0fdf4;
      border-left: 3px solid #22c55e;
    }

    .snapshot-node--case_study {
      background: #fff7ed;
      border-left: 3px solid #f97316;
    }

    .snapshot-node--instruction {
      background: #eef2ff;
      border-left: 3px solid #6366f1;
    }

    .snapshot-node--cover_page {
      background: #f8fafc;
      border-left: 3px solid #2563eb;
    }

    .snapshot-node__content p {
      margin-bottom: .5rem;
    }

    .snapshot-node__meta {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      background: rgba(99, 102, 241, 0.18);
      color: #3730a3;
      font-size: 0.72rem;
      font-weight: 600;
      border-radius: 999px;
      padding: 2px 8px;
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .25rem .65rem;
      border-radius: 999px;
      font-weight: 600;
    }

    .badge-status.info {
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
    }

    .badge-status.warning {
      background: rgba(250, 204, 21, 0.18);
      color: #b45309;
    }

    .badge-status.success {
      background: rgba(34, 197, 94, 0.15);
      color: #047857;
    }

    .badge-status.default {
      background: rgba(148, 163, 184, 0.18);
      color: #475569;
    }

    .snapshot-select {
      max-width: 320px;
    }

    .snapshot-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: .5rem;
      min-width: 220px;
    }

    .snapshot-actions .btn {
      width: 100%;
    }

    .snapshot-breadcrumb {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-top: 1rem;
    }

    .snapshot-breadcrumb span {
      background: rgba(79, 70, 229, 0.1);
      color: #312e81;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
    }

    /* NEW: Memo section styles */
    .memo-section {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      background: #f8f9fa;
    }

    .memo-section.has-memo {
      border-color: #198754;
      background: #f8fff9;
    }

    .memo-section.requires-memo {
      border-color: #fd7e14;
      background: #fff3e0;
    }

    .memo-upload-form {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .memo-file-input {
      flex: 1;
      min-width: 250px;
    }

    .memo-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 500;
    }

    .memo-status.success {
      background: #d1e7dd;
      color: #0f5132;
      border: 1px solid #badbcc;
    }

    .memo-status.warning {
      background: #fff3cd;
      color: #664d03;
      border: 1px solid #ffecb5;
    }

    .memo-filename {
      font-family: monospace;
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .editable-block[data-editable="true"] {
      border: 1px dashed rgba(99,102,241,0.6);
      padding: 6px 8px;
      border-radius: 6px;
      min-height: 34px;
      cursor: text;
      background: rgba(99,102,241,0.04);
      transition: background 0.2s ease;
    }
    .editable-block[data-editable="true"]:focus-within,
    .editable-block[data-editable="true"]:focus {
      background: rgba(99,102,241,0.08);
      outline: none;
    }
    .editable-block[data-editable="false"] {
      cursor: default;
    }
    .block-editor-panel {
      max-height: 60vh;
      overflow-y: auto;
    }
    .block-editor-segment {
      border: 1px solid #dfe3f0;
      border-radius: 10px;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      background: #fff;
    }
    .block-editor-editable {
      min-height: 80px;
      border: 1px dashed rgba(79,70,229,0.5);
      border-radius: 8px;
      padding: 0.65rem;
      background: #fdfcff;
      white-space: pre-wrap;
    }
    .block-editor-image {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .block-editor-image img {
      max-width: 180px;
      max-height: 180px;
      border-radius: 6px;
      border: 1px solid rgba(15,23,42,0.1);
      box-shadow: 0 1px 4px rgba(15,23,42,0.15);
      background: #fff;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% if created_snapshot %}
    <div
      class="alert alert-success d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
      <div>
        <strong>Randomized paper saved.</strong> {{ created_snapshot_details.eisa|default:assessment.eisa_id }} is now
        available.
        <div class="small text-muted">Paper ID {{ created_snapshot_details.paper_id|default:paper.id }} | Marks {{
          created_snapshot_details.marks|default:paper.total_marks|default:'0' }} | Pool size {{
          created_snapshot_details.pool|default:random_meta.snapshot_pool_size|default:'0' }} | Total randomized papers
          {{ snapshots_total }}</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-success" href="{% url 'assessor_developer' %}">Back to Randomization
          Dashboard</a>
      </div>
    </div>
    {% endif %}
    <div class="mb-3">
      <a href="{% url 'assessor_developer' %}" class="text-decoration-none">&larr; Back to Assessor Developer</a>
    </div>

    <div class="snapshot-card">
      <div class="snapshot-header">
        <div>
          <h2 class="mb-1">Randomized Paper - {{ assessment.eisa_id }}</h2>
          <div class="text-muted">Qualification: {{ assessment.qualification.name|default:"Not linked" }}</div>
          {% if assessment.status %}
          {% with status=assessment.status %}
          {% if "ETQA" in status %}
          <span class="badge-status info mt-2">{{ status }}</span>
          {% elif "QCTO" in status %}
          <span class="badge-status warning mt-2">{{ status }}</span>
          {% elif "Approved" in status %}
          <span class="badge-status success mt-2">{{ status }}</span>
          {% else %}
          <span class="badge-status default mt-2">{{ status }}</span>
          {% endif %}
          {% endwith %}
          {% endif %}
        </div>
        <div class="snapshot-actions">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
            data-bs-target="#snapshotModal">View Saved Randomized Papers</button>
          <small class="text-muted text-end">Randomized papers are reconstructions generated from captured content
            blocks.</small>
          <label for="snapshot-switch" class="form-label mb-0">Jump to paper</label>
          <select id="snapshot-switch" class="form-select form-select-sm">
            <option value="">Current paper</option>
            {% for snap in randomized_snapshots %}
            <option value="{% url 'assessor_randomized_snapshot' snap.id %}" {% if snap.id == assessment.id %}selected{% endif %}>{{ snap.eisa_id }} - {{ snap.paper }}</option>
            
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="snapshot-breadcrumb">
        {% if base_paper %}
        <span>Base Paper: {{ base_paper.name }} (ID {{ base_paper.id }})</span>
        {% endif %}
        {% if paper %}
        <span>Randomized Paper ID: {{ paper.id }}</span>
        {% endif %}
        {% if assessment.paper %}
        <span>Paper Title: {{ assessment.paper }}</span>
        {% endif %}
        {% if module_name_meta %}
        <span>Module: {{ module_name_meta }}</span>
        {% endif %}
        {% if module_number_meta %}
        <span>Paper Letter: {{ module_number_meta }}</span>
        {% elif paper.paper_letter %}
        <span>Paper Letter: {{ paper.paper_letter }}</span>
        {% endif %}
        {% if paper.paper_number %}
        <span>Paper Number: {{ paper.paper_number }}</span>
        {% endif %}
        <span>Randomized Assessment ID: {{ current_snapshot_id }}</span>
        {% if assessment.eisa_id %}
        <span>EISA: {{ assessment.eisa_id }}</span>
        {% endif %}
      </div>

      <div class="row mt-3 g-3">
        <div class="col-md-8">
          <dl class="row mb-0">
            <dt class="col-sm-4">Paper name</dt>
            <dd class="col-sm-8">{{ assessment.paper }}</dd>
            <dt class="col-sm-4">Created</dt>
            <dd class="col-sm-8">{{ assessment.created_at|date:"M j, Y H:i" }}</dd>
            <dt class="col-sm-4">Total marks</dt>
            <dd class="col-sm-8">{{ paper.total_marks|default:"0" }}</dd>
            {% if qual_name_meta %}
            <dt class="col-sm-4">Qualification</dt>
            <dd class="col-sm-8">{{ qual_name_meta }}</dd>
            {% endif %}
            {% if base_paper %}
            <dt class="col-sm-4">Base paper origin</dt>
            <dd class="col-sm-8">{{ base_paper.name }} (ID {{ base_paper.id }})</dd>
            {% endif %}
            {% if random_meta.module_name or module_name_meta %}
            <dt class="col-sm-4">Module</dt>
            <dd class="col-sm-8">{{ random_meta.module_name|default:module_name_meta }}</dd>
            {% endif %}
            {% if random_meta.module_number or module_number_meta %}
            <dt class="col-sm-4">Paper letter</dt>
            <dd class="col-sm-8">{{ random_meta.module_number|default:module_number_meta }}</dd>
            {% endif %}
            {% if random_meta.status or random_status_label %}
            <dt class="col-sm-4">Randomization status</dt>
            <dd class="col-sm-8 text-capitalize">{{ random_meta.status|default:random_status_label }}</dd>
            {% endif %}
            {% if allowed_letters_display %}
            <dt class="col-sm-4">Available versions</dt>
            <dd class="col-sm-8">{{ allowed_letters_display }}</dd>
            {% endif %}
            {% if random_meta.cover_title or cover_heading_meta %}
            <dt class="col-sm-4">Cover title</dt>
            <dd class="col-sm-8">{{ random_meta.cover_title|default:cover_heading_meta }}</dd>
            {% endif %}
            {% if random_meta.source %}
            <dt class="col-sm-4">Source</dt>
            <dd class="col-sm-8 text-capitalize">{{ random_meta.source }}</dd>
            {% elif random_meta.snapshot_pool_used %}
            <dt class="col-sm-4">Source</dt>
            <dd class="col-sm-8">Snapshot pool ({{ random_meta.snapshot_pool_size|default:"0" }})</dd>
            {% endif %}
            {% if random_meta.snapshot_pool_size %}
            <dt class="col-sm-4">Pool size</dt>
            <dd class="col-sm-8">{{ random_meta.snapshot_pool_size }}</dd>
            {% endif %}
            {% if random_meta.last_refreshed %}
            <dt class="col-sm-4">Last refreshed</dt>
            <dd class="col-sm-8">{{ random_meta.last_refreshed }}</dd>
            {% endif %}
          </dl>
        </div>
        <div class="col-md-4">
          <div class="bg-light rounded-3 p-3 h-100">
            <div class="fw-semibold mb-2">Structure overview</div>
            <div>Questions: <strong>{{ node_stats.questions }}</strong></div>
            <div>Tables: <strong>{{ node_stats.tables }}</strong></div>
            <div>Images: <strong>{{ node_stats.images }}</strong></div>
            <div>Instructions: <strong>{{ node_stats.instructions }}</strong></div>
          </div>
        </div>
      </div>

      <!-- NEW: Memo Upload Section -->
      <div class="memo-section {% if has_memo %}has-memo{% else %}requires-memo{% endif %} mt-4">
        <h5 class="mb-3">Moderator Memo</h5>
        
        {% if has_memo %}
        <div class="mb-3">
          <div class="memo-status success">
            <span>✅ Memo uploaded successfully</span>
          </div>
          <div class="mt-2">
            <strong>File:</strong> 
            <span class="memo-filename">{{ memo_filename }}</span>
            <a href="{% url 'download_memo' assessment.id %}" class="btn btn-sm btn-outline-primary ms-2" target="_blank">
              Download Memo
            </a>
          </div>
        </div>
        
        <form method="post" enctype="multipart/form-data" class="memo-upload-form">
          {% csrf_token %}
          <div class="memo-file-input">
            <label for="memo-file-replace" class="form-label">Replace memo file:</label>
            <input type="file" class="form-control form-control-sm" id="memo-file-replace" name="memo_file" accept=".pdf,.doc,.docx">
            <div class="form-text">Allowed formats: PDF, DOC, DOCX</div>
          </div>
          <button type="submit" name="action" value="upload_memo" class="btn btn-warning btn-sm">
            Replace Memo
          </button>
        </form>
        {% else %}
        <div class="mb-3">
          <div class="memo-status warning">
            <span>⚠️ {{ memo_requirement_message }}</span>
          </div>
        </div>
        
        <form method="post" enctype="multipart/form-data" class="memo-upload-form">
          {% csrf_token %}
          <div class="memo-file-input">
            <label for="memo-file" class="form-label">Upload memo file:</label>
            <input type="file" class="form-control" id="memo-file" name="memo_file" accept=".pdf,.doc,.docx" required>
            <div class="form-text">Allowed formats: PDF, DOC, DOCX</div>
          </div>
          <button type="submit" name="action" value="upload_memo" class="btn btn-primary">
            Upload Memo
          </button>
        </form>
        {% endif %}
      </div>

      <form method="post" class="mt-3 d-flex flex-wrap gap-2">
        {% csrf_token %}
        <input type="hidden" name="refresh" value="0">
        <div class="alert alert-light border w-100 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
          <div>
            <strong>Editing mode:</strong>
            <span data-editor-mode-label>Paper (learner block)</span>
            <div class="small text-muted">Choose whether current block text represents the learner paper or the memo.</div>
          </div>
          <div class="btn-group btn-group-sm" role="group" data-editor-mode-group>
            <button type="button" class="btn btn-outline-primary active" data-set-mode="paper">Paper</button>
            <button type="button" class="btn btn-outline-primary" data-set-mode="memo">Memo</button>
          </div>
        </div>
        {% if can_open_pipeline %}
        <button type="submit" name="action" value="open_pipeline" class="btn btn-sm btn-primary">Open in Advanced
          Pipeline</button>
        <button type="submit" name="action" value="open_pipeline" class="btn btn-sm btn-outline-secondary"
          onclick="this.form.refresh.value='1'">Rebuild &amp; Open</button>
        {% endif %}
        
        <!-- UPDATED: Forward to Moderator Button with memo check -->
        {% if assessment.status != 'Submitted to Moderator' %}
          {% if can_forward_to_moderator %}
          <button type="submit" name="action" value="forward_moderator" class="btn btn-sm btn-warning">Forward to
            Moderator</button>
          {% else %}
          <button type="button" class="btn btn-sm btn-warning" disabled title="{{ memo_requirement_message }}">
            Forward to Moderator
          </button>
          <small class="text-muted align-self-center">Upload memo first</small>
          {% endif %}
        {% else %}
        <span class="small text-muted align-self-center">Already forwarded to moderator.</span>
        {% endif %}
        
        <!-- <button type="submit" name="action" value="forward_etqa" class="btn btn-sm btn-warning text-white">Forward
          ETQA</button> -->
        <!-- <button type="submit" name="action" value="forward_qcto" class="btn btn-sm btn-outline-warning">Forward
          QCTO</button> -->
        {% if assessment.status != 'Released to students' %}
        <!-- <button type="submit" name="action" value="release_students" class="btn btn-sm btn-success">Release to
          Learners</button> -->
        {% endif %}
        <div class="w-100 mt-2">
          <!-- <button type="submit" name="action" value="create_snapshot" class="btn btn-success btn-lg w-100">Save New
            Randomized Paper</button> -->
        </div>
        <div class="w-100 mt-2">
          <!-- <button type="submit" name="action" value="update_snapshot"
            class="btn btn-info btn-lg text-white w-100">Refresh Randomized Paper</button> -->
        </div>
        <div class="w-100 mt-2 text-end d-flex gap-2 justify-content-end flex-wrap">
          <a href="{% url 'download_randomized_pdf' assessment.id %}?format=pdf" class="btn btn-outline-secondary"
            data-role="download-pdf">
            <i class="fa fa-download"></i> Download PDF
          </a>
          <a href="{% url 'download_randomized_pdf' assessment.id %}?format=docx" class="btn btn-outline-primary">
            <i class="fa fa-file-word-o"></i> Download Word (.docx)
          </a>
          <!--
          <a href="{% url 'download_randomized_pdf' assessment.id %}?format=docx&variant=memo"
            class="btn btn-outline-success">
            <i class="fa fa-file-word-o"></i> Download Memo (.docx)
          </a>
          <a href="{% url 'download_randomized_pdf' assessment.id %}?format=pdf&variant=memo"
            class="btn btn-outline-success">
            <i class="fa fa-download"></i> Download Memo PDF
          </a>
          -->
        </div>
      </form>
    </div>


    {% if cover_nodes %}
    <div class="snapshot-card">
      <h4 class="mb-3">Cover &amp; Instructions</h4>
      {% if random_meta.cover_title|default:cover_heading_meta %}
      <div class="alert alert-secondary py-2 px-3 mb-3">{{ random_meta.cover_title|default:cover_heading_meta }}</div>
      {% endif %}
      {% for node in cover_nodes %}
      {% include 'core/assessor-developer/_snapshot_node.html' with node=node %}
      {% endfor %}
    </div>
    {% endif %}

    {% if question_nodes %}
    <div class="snapshot-card">
      <h4 class="mb-3">Questions</h4>
      {% for node in question_nodes %}
      {% include 'core/assessor-developer/_snapshot_node.html' with node=node %}
      {% endfor %}
    </div>
    {% elif paper %}
    <div class="snapshot-card">
      <h4 class="mb-3">Questions</h4>
      <p class="text-muted mb-0">No structured question nodes were saved for this paper.</p>
    </div>
    {% else %}
    <div class="snapshot-card">
      <h4 class="mb-3">Reconstructed Paper</h4>
      <p class="text-muted mb-0">This randomized paper does not have an attached reconstructed paper yet.</p>
    </div>
    {% endif %}
  </div>

  <div class="modal fade" id="snapshotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Saved Randomized Papers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% if randomized_snapshots %}
          <div class="list-group">
            {% for snap in randomized_snapshots %}
            <a href="{% url 'assessor_randomized_snapshot' snap.id %}"
              class="list-group-item list-group-item-action{% if snap.id == assessment.id %} active{% endif %}">
              <div class="d-flex w-100 justify-content-between">
                <span>{{ snap.eisa_id }} - {{ snap.paper }}</span>
                <small>{{ snap.created_at|date:"M j, Y H:i" }}</small>
              </div>
              <small class="text-muted d-block">Module {{ snap.module_name|default:"-" }} {{
                snap.module_number|default:"" }} | Paper ID {{ snap.paper_link.id }} | Status {{ snap.status }}</small>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">No randomized papers captured yet.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="rawBlockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Full Block Editor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted">Edit the complete block JSON below. This represents the exact content (text, tables, images) that will appear in the paper.</p>
          <div class="btn-group btn-group-sm mb-2" role="group" data-role="raw-editor-toggle">
            <button type="button" class="btn btn-outline-secondary active" data-editor-panel="json">JSON Mode</button>
            <button type="button" class="btn btn-outline-secondary" data-editor-panel="block">Visual Block Mode</button>
          </div>
          <textarea class="form-control font-monospace" rows="14" data-role="raw-textarea"></textarea>
          <div class="block-editor-panel d-none mt-2" data-role="block-editor-panel">
            <div class="text-muted small">Visual block editor will appear here.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-role="raw-inline">Use Inline Editor</button>
          <button type="button" class="btn btn-primary" data-role="raw-apply">Use This JSON</button>
          <button type="button" class="btn btn-success" data-role="raw-save">Save Block</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get('download') === '1') {
        const link = document.querySelector('[data-role="download-pdf"]');
        if (link) {
          window.open(link.href, '_blank');
        }
      }
    })();

    document.getElementById('snapshot-switch')?.addEventListener('change', function () {
      if (this.value && this.value !== window.location.href) {
        window.location.href = this.value;
      }
    });

    // NEW: File input validation
    document.querySelectorAll('input[type="file"][name="memo_file"]').forEach(input => {
      input.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const fileExt = file.name.split('.').pop().toLowerCase();
          const allowedTypes = ['pdf', 'doc', 'docx'];
          if (!allowedTypes.includes(fileExt)) {
            alert('Invalid file type. Please select a PDF, DOC, or DOCX file.');
            this.value = '';
          }
        }
      });
    });

    // Editable block serialization and submission
    function serializeNodeContent(container) {
      let base = [];
      try {
        base = JSON.parse(container.dataset.nodeContent || "[]");
      } catch (err) {
        base = [];
      }
      return base.map((block, idx) => {
        const editable = container.querySelector(`.editable-block[data-block-index="${idx}"]`);
        if (editable && editable.dataset.editable === "true") {
          const clone = Object.assign({}, block);
          const blockType = ((clone && clone.type) || "").toLowerCase();
          if (blockType === "table") {
            clone.html = editable.innerHTML.trim();
          } else if (blockType === "image" || blockType === "figure") {
            clone.caption = editable.innerText.trim();
          } else {
            clone.text = editable.innerText.trim();
          }
          return clone;
        }
        return block;
      });
    }

    let rawModalInstance = null;
    let rawModalForm = null;
    let rawModalContainer = null;
    let rawTextarea = null;
    let rawModalPanelMode = "json";
    let rawModalBlockData = [];
    let rawModalBlockPanel = null;
    let rawEditorToggleButtons = [];
    let rawModalSaveButton = null;

    function cloneBlockArray(data) {
      try {
        return JSON.parse(JSON.stringify(Array.isArray(data) ? data : []));
      } catch (err) {
        return [];
      }
    }

    function openRawEditor(form, container) {
      if (!rawModalInstance) return;
      rawModalForm = form;
      rawModalContainer = container;
      const contentField = form.querySelector('[data-field="node-content"]');
      let payload = [];
      try {
        payload = serializeNodeContent(container);
      } catch (err) {
        try {
          payload = JSON.parse(contentField?.value || "[]");
        } catch (err2) {
          payload = [];
        }
      }
      if (!Array.isArray(payload)) {
        try {
          payload = JSON.parse(contentField?.value || "[]");
        } catch (err3) {
          payload = [];
        }
      }
      rawModalBlockData = cloneBlockArray(payload);
      const initial = JSON.stringify(rawModalBlockData, null, 2);
      if (rawTextarea) {
        rawTextarea.value = initial;
        rawTextarea.classList.remove("d-none");
      }
      if (rawModalBlockPanel) {
        rawModalBlockPanel.classList.add("d-none");
        rawModalBlockPanel.innerHTML = '<div class="text-muted small">Visual block editor will appear here.</div>';
      }
      rawModalPanelMode = "json";
      updateEditorToggleButtons("json");
      rawModalInstance.show();
    }

    function updateEditorToggleButtons(mode) {
      rawEditorToggleButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.editorPanel === mode);
      });
    }

    function ensureBlockDataFromTextarea() {
      if (Array.isArray(rawModalBlockData) && rawModalBlockData.length) {
        return true;
      }
      if (!rawTextarea) {
        rawModalBlockData = [];
        return false;
      }
      try {
        const parsed = JSON.parse(rawTextarea.value || "[]");
        rawModalBlockData = Array.isArray(parsed) ? parsed : [];
        return true;
      } catch (err) {
        alert("Unable to parse JSON. Please fix errors before opening the visual editor.");
        return false;
      }
    }

    function blockContentToHTML(block) {
      if (!block) {
        return "";
      }
      const type = (block.type || "").toLowerCase();
      if (type === "table") {
        return block.html || "";
      }
      if (type === "image" || type === "figure") {
        const caption = block.caption || block.text || "";
        const images = block.images || block.image;
        if (Array.isArray(images) && images.length) {
          return caption || JSON.stringify(images);
        }
        return caption || block.url || "";
      }
      const textValue = block.text || "";
      return textValue ? textValue.replace(/\n/g, "<br>") : "";
    }

    function extractImageSources(block) {
      const sources = [];
      if (!block || typeof block !== "object") {
        return sources;
      }
      const pushIfValid = (val) => {
        if (typeof val === "string" && val.trim()) {
          sources.push(val.trim());
        }
      };
      const handleEntry = (entry) => {
        if (!entry) return;
        if (typeof entry === "string") {
          pushIfValid(entry);
          return;
        }
        if (typeof entry === "object") {
          if (entry.data_uri && entry.data_uri.startsWith("data:")) {
            pushIfValid(entry.data_uri);
            return;
          }
          if (entry.url) {
            pushIfValid(entry.url);
            return;
          }
          if (entry.path) {
            pushIfValid(entry.path);
            return;
          }
          if (entry.filename) {
            pushIfValid(entry.filename);
            return;
          }
          if (entry.name) {
            pushIfValid(entry.name);
            return;
          }
        }
      };
      if (block.data_uri) {
        pushIfValid(block.data_uri);
      }
      if (block.url) {
        pushIfValid(block.url);
      }
      const images = block.images || block.image;
      if (Array.isArray(images)) {
        images.forEach(handleEntry);
      } else if (images) {
        handleEntry(images);
      }
      return sources;
    }

    function renderBlockEditorPanel() {
      if (!rawModalBlockPanel) return;
      rawModalBlockPanel.innerHTML = "";
      if (!Array.isArray(rawModalBlockData) || !rawModalBlockData.length) {
        rawModalBlockPanel.innerHTML = '<div class="text-muted small">No structured content was captured for this block.</div>';
        return;
      }
      rawModalBlockData.forEach((block, idx) => {
        const segment = document.createElement("div");
        segment.className = "block-editor-segment";
        segment.dataset.blockIndex = idx;
        const label = document.createElement("div");
        label.className = "small text-muted mb-1";
        label.textContent = `Block ${idx + 1} (${block.type || "text"})`;
        const blockType = (block.type || "").toLowerCase();
        segment.appendChild(label);
        if (blockType === "image" || blockType === "figure") {
          const preview = document.createElement("div");
          preview.className = "block-editor-image";
          const sources = extractImageSources(block);
          if (sources.length) {
            sources.forEach((src) => {
              const img = document.createElement("img");
              img.src = src;
              img.alt = "Figure preview";
              preview.appendChild(img);
            });
          } else {
            const placeholder = document.createElement("div");
            placeholder.className = "text-muted small";
            placeholder.textContent = "Image preview unavailable.";
            preview.appendChild(placeholder);
          }
          segment.appendChild(preview);
        }
        const editable = document.createElement("div");
        editable.className = "block-editor-editable";
        editable.dataset.blockIndex = idx;
        editable.contentEditable = "true";
        editable.innerHTML = blockContentToHTML(block);
        segment.appendChild(label);
        segment.appendChild(editable);
        rawModalBlockPanel.appendChild(segment);
      });
      const helper = document.createElement("div");
      helper.className = "small text-muted";
      helper.textContent = "Tip: Use Shift+Enter for a new line. Changes above will be written back into the block JSON.";
      rawModalBlockPanel.appendChild(helper);
    }

    function collectBlockEditorPayload() {
      if (!Array.isArray(rawModalBlockData)) {
        return [];
      }
      const updated = cloneBlockArray(rawModalBlockData);
      if (!rawModalBlockPanel) {
        return updated;
      }
      rawModalBlockPanel.querySelectorAll("[data-block-index]").forEach((editable) => {
        const idx = Number(editable.dataset.blockIndex);
        if (Number.isNaN(idx) || !updated[idx]) return;
        const block = updated[idx];
        const type = (block.type || "").toLowerCase();
        if (type === "table") {
          block.html = editable.innerHTML.trim();
        } else if (type === "image" || type === "figure") {
          block.caption = editable.innerText.trim();
        } else {
          const htmlValue = editable.innerHTML.replace(/<div><br><\/div>/gi, "<br>");
          const textValue = htmlValue.replace(/<br\s*\/?>/gi, "\n").replace(/&nbsp;/gi, " ").trim();
          block.text = textValue;
        }
      });
      return updated;
    }

    function writeRawEditorToField() {
      if (!rawModalForm) return false;
      const contentField = rawModalForm.querySelector('[data-field="node-content"]');
      const rawModeField = rawModalForm.querySelector('[data-field="raw-mode"]');
      if (!contentField) return false;
      let payloadValue = null;
      if (rawModalPanelMode === "block" && rawModalBlockPanel && !rawModalBlockPanel.classList.contains("d-none")) {
        const updated = collectBlockEditorPayload();
        rawModalBlockData = cloneBlockArray(updated);
        payloadValue = JSON.stringify(rawModalBlockData);
        if (rawTextarea) {
          rawTextarea.value = JSON.stringify(rawModalBlockData, null, 2);
        }
      } else if (rawTextarea) {
        payloadValue = rawTextarea.value.trim() || "[]";
      } else {
        payloadValue = "[]";
      }
      contentField.value = payloadValue;
      if (rawModeField) {
        rawModeField.value = "on";
      }
      return true;
    }

    function switchEditorPanel(mode) {
      if (!mode || mode === rawModalPanelMode) {
        updateEditorToggleButtons(mode || rawModalPanelMode);
        return true;
      }
      if (mode === "block") {
        if (!ensureBlockDataFromTextarea()) {
          return false;
        }
        if (rawTextarea) {
          rawTextarea.classList.add("d-none");
        }
        if (rawModalBlockPanel) {
          rawModalBlockPanel.classList.remove("d-none");
          renderBlockEditorPanel();
        }
        rawModalPanelMode = "block";
        updateEditorToggleButtons("block");
        return true;
      }
      if (mode === "json") {
      if (rawModalPanelMode === "block") {
        const updated = collectBlockEditorPayload();
        rawModalBlockData = cloneBlockArray(updated);
        if (rawTextarea) {
          rawTextarea.value = JSON.stringify(rawModalBlockData, null, 2);
          }
        }
        rawModalPanelMode = "json";
        if (rawTextarea) {
          rawTextarea.classList.remove("d-none");
        }
        if (rawModalBlockPanel) {
          rawModalBlockPanel.classList.add("d-none");
        }
        updateEditorToggleButtons("json");
        return true;
      }
      return false;
    }

    document.querySelectorAll("[data-node-form]").forEach(form => {
      const container = form.closest(".snapshot-node");
      if (!container) return;

      const textBlock = container.querySelector('[data-text-block="true"]');
      const rawModeField = form.querySelector('[data-field="raw-mode"]');
      const rawToggle = form.querySelector('[data-role="toggle-raw"]');

      function updateHiddenFields() {
        const rawModeActive = rawModeField && rawModeField.value === "on";
        const textPayload = textBlock ? textBlock.innerText.trim() : "";
        const contentField = form.querySelector('[data-field="node-content"]');
        const textField = form.querySelector('[data-field="node-text"]');
        if (textField) textField.value = textPayload;
        if (rawModeActive) {
          return;
        }
        if (contentField) {
          contentField.value = JSON.stringify(serializeNodeContent(container));
        }
      }

      if (rawToggle && rawModeField) {
        rawToggle.addEventListener("click", (event) => {
          event.preventDefault();
          openRawEditor(form, container);
        });
      }

      form.querySelectorAll("[data-submit-action]").forEach(button => {
        button.addEventListener("click", event => {
          event.preventDefault();
          updateHiddenFields();
          form.querySelector('input[name="action"]').value = button.dataset.submitAction || "";
          form.submit();
        });
      });
    });

    // Editor mode toggle
    const modeButtons = document.querySelectorAll("[data-set-mode]");
    const modeLabel = document.querySelector("[data-editor-mode-label]");
    const addMemoButtons = document.querySelectorAll('[data-role="add-memo"]');
    const editorModeFields = document.querySelectorAll('[data-field="editor-mode"]');

    function applyEditorMode(mode) {
      const normalized = mode === "memo" ? "memo" : "paper";
      modeButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.setMode === normalized);
      });
      editorModeFields.forEach(field => {
        field.value = normalized;
      });
      addMemoButtons.forEach(btn => {
        if (normalized === "memo") {
          btn.textContent = "Add Corresponding Question Block";
        } else {
          btn.textContent = "Add Corresponding Memo";
        }
      });
      if (modeLabel) {
        modeLabel.textContent = normalized === "memo" ? "Memo (answer capture)" : "Paper (learner block)";
      }
    }

    const savedMode = localStorage.getItem("snapshotEditorMode") || "paper";
    applyEditorMode(savedMode);

    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const newMode = btn.dataset.setMode;
        localStorage.setItem("snapshotEditorMode", newMode);
        applyEditorMode(newMode);
      });
    });
    const rawModalEl = document.getElementById("rawBlockModal");
    if (rawModalEl) {
      rawModalInstance = new bootstrap.Modal(rawModalEl);
      rawTextarea = rawModalEl.querySelector('[data-role="raw-textarea"]');
      rawModalBlockPanel = rawModalEl.querySelector('[data-role="block-editor-panel"]');
      rawEditorToggleButtons = rawModalEl.querySelectorAll("[data-editor-panel]");
      const applyBtn = rawModalEl.querySelector('[data-role="raw-apply"]');
      const inlineBtn = rawModalEl.querySelector('[data-role="raw-inline"]');
      rawModalSaveButton = rawModalEl.querySelector('[data-role="raw-save"]');
      rawEditorToggleButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.editorPanel;
          switchEditorPanel(mode);
        });
      });
      rawTextarea?.addEventListener("input", () => {
        if (rawModalPanelMode === "json") {
          rawModalBlockData = [];
        }
      });

      applyBtn?.addEventListener("click", () => {
        if (!writeRawEditorToField()) return;
        rawModalInstance.hide();
      });

      inlineBtn?.addEventListener("click", () => {
        if (!rawModalForm || !rawModalContainer) return;
        if (rawModalPanelMode === "block") {
          const updated = collectBlockEditorPayload();
          rawModalBlockData = cloneBlockArray(updated);
          if (rawTextarea) {
            rawTextarea.value = JSON.stringify(rawModalBlockData, null, 2);
          }
          switchEditorPanel("json");
        }
        const rawModeField = rawModalForm.querySelector('[data-field="raw-mode"]');
        const contentField = rawModalForm.querySelector('[data-field="node-content"]');
        if (rawModeField) {
          rawModeField.value = "off";
        }
        if (contentField) {
          contentField.value = JSON.stringify(serializeNodeContent(rawModalContainer));
        }
        rawModalInstance.hide();
      });

      rawModalSaveButton?.addEventListener("click", () => {
        if (!writeRawEditorToField() || !rawModalForm) return;
        const actionField = rawModalForm.querySelector('input[name="action"]');
        if (actionField) {
          actionField.value = "save_node_content";
        }
        rawModalInstance.hide();
        rawModalForm.submit();
      });
    }
  </script>
</body>

</html>
