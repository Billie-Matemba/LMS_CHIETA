<!-- Memo Paper Randomisation Partial with Toggle UI -->

<div class="memo-randomisation-container" id="memoRandomisationContainer">
    <div class="memo-controls mb-4">
        <h5 class="mb-3">
            <i class="fas fa-random"></i> Randomise with Memo
        </h5>
        <form id="memoRandomisationForm" method="POST" action="{% url 'randomise_paper_with_memo' %}">
            {% csrf_token %}

            <!-- Hidden inputs for paper/qualification context -->
            <input type="hidden" name="paper_id" value="{{ paper.id }}">
            <input type="hidden" name="qualification_id" value="{{ qualification.id }}">
            <input type="hidden" name="memo_data" id="memoDataInput" value="{}">

            <!-- Randomisation Rules Section -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-cog"></i> Randomisation Rules
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input randomise-rule" type="checkbox" id="sameTopLevel"
                                    name="same_top_level" value="true">
                                <label class="form-check-label" for="sameTopLevel">
                                    Same top-level only (1.x with 1.x)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="marksTolerance" class="form-label">Marks Tolerance</label>
                                <input type="number" class="form-control form-control-sm" id="marksTolerance"
                                    name="marks_tolerance" placeholder="Leave blank for no filter" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <label for="requiredTags" class="form-label">Required Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="requiredTags" name="required_tags"
                            placeholder="e.g., nated, matric, advanced">
                    </div>
                </div>
            </div>

            <!-- Questions with Memo Toggles Section -->
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list"></i> Questions & Memos</span>
                    <small class="text-white-50">Toggle to edit memo for each question</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 45%">Question</th>
                                    <th style="width: 10%">Marks</th>
                                    <th style="width: 25%">Memo</th>
                                    <th style="width: 15%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="questionsTableBody">
                                {% for node in nodes %}
                                {% if node.type == 'question' %}
                                <tr class="question-row" data-question-id="{{ node.id }}"
                                    data-question-number="{{ node.number }}">
                                    <td class="align-middle">
                                        <span class="badge bg-secondary">{{ node.number }}</span>
                                    </td>
                                    <td class="align-middle">
                                        <small class="text-muted d-block">{{
                                            node.content|first|get_item:'text'|truncatewords:15 }}</small>
                                    </td>
                                    <td class="align-middle text-center">
                                        <span class="badge bg-warning">{{ node.marks|default:'-' }}</span>
                                    </td>
                                    <td class="align-middle">
                                        <!-- Memo Display / Toggle -->
                                        <div class="memo-toggle-group">
                                            <button type="button" class="btn btn-sm btn-outline-info memo-toggle-btn"
                                                data-question-id="{{ node.id }}" data-bs-toggle="modal"
                                                data-bs-target="#memoEditorModal" title="Edit memo for this question">
                                                <i class="fas fa-pen"></i> Edit Memo
                                            </button>
                                            <span class="memo-status-badge badge bg-light text-dark ms-2"
                                                data-question-id="{{ node.id }}">
                                                <i class="fas fa-file-alt"></i> No memo
                                            </span>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <!-- Action buttons -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary copy-question-btn"
                                                data-question-id="{{ node.id }}" title="Copy question to clipboard">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger remove-question-btn"
                                                data-question-id="{{ node.id }}" title="Remove from randomisation">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-check"></i> Generate Randomised Paper with Memos
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Memo Editor Modal -->
<div class="modal fade" id="memoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="memoModalTitle">
                    <i class="fas fa-pen-fancy"></i> Edit Memo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Question Number:</strong></label>
                    <div id="memoQuestionNumber" class="mb-3 p-2 bg-light rounded">-</div>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Question Preview:</strong></label>
                    <div id="memoQuestionPreview" class="mb-3 p-3 bg-light rounded border-start border-4 border-info"
                        style="max-height: 200px; overflow-y: auto;">
                        No question text available
                    </div>
                </div>
                <div class="mb-3">
                    <label for="memoContent" class="form-label">
                        <strong>Memo Content <span class="text-danger">*</span></strong>
                    </label>
                    <textarea id="memoContent" class="form-control" rows="8"
                        placeholder="Enter the memo/answer for this question..." required></textarea>
                    <small class="text-muted d-block mt-2">
                        ðŸ’¡ Tip: Use clear formatting, bullet points, and step-by-step explanations.
                    </small>
                </div>
                <div class="mb-3">
                    <label for="memoNotes" class="form-label">Additional Notes (Optional)</label>
                    <textarea id="memoNotes" class="form-control" rows="3"
                        placeholder="Any additional notes, warnings, or clarifications..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="saveMemoBtn">
                    <i class="fas fa-save"></i> Save Memo
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .memo-randomisation-container {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .question-row {
        transition: background-color 0.2s;
    }

    .question-row:hover {
        background-color: #f8f9fa;
    }

    .memo-toggle-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .memo-status-badge {
        font-size: 0.75rem;
        white-space: nowrap;
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const memoEditorModal = new bootstrap.Modal(document.getElementById('memoEditorModal'));
        const memoDataInput = document.getElementById('memoDataInput');
        let currentQuestionId = null;
        let memoData = {}; // { questionId: { content: '', notes: '' } }

        // Load existing memos from form (if any)
        try {
            const existing = JSON.parse(memoDataInput.value || '{}');
            memoData = existing;
        } catch (e) {
            memoData = {};
        }

        // Edit Memo Button Click
        document.querySelectorAll('.memo-toggle-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const questionId = this.dataset.questionId;
                const questionNumber = this.closest('.question-row').dataset.questionNumber;
                const questionRow = this.closest('.question-row');
                const questionText = questionRow.querySelector('small.text-muted').textContent.trim();

                currentQuestionId = questionId;

                // Populate modal
                document.getElementById('memoQuestionNumber').textContent = questionNumber;
                document.getElementById('memoQuestionPreview').textContent = questionText || 'No question text available';

                const existing = memoData[questionId] || {};
                document.getElementById('memoContent').value = existing.content || '';
                document.getElementById('memoNotes').value = existing.notes || '';

                // Update modal title
                document.getElementById('memoModalTitle').innerHTML =
                    `<i class="fas fa-pen-fancy"></i> Edit Memo â€” Q${questionNumber}`;
            });
        });

        // Save Memo Button Click
        document.getElementById('saveMemoBtn').addEventListener('click', function () {
            const content = document.getElementById('memoContent').value.trim();
            const notes = document.getElementById('memoNotes').value.trim();

            if (!content) {
                alert('Please enter memo content.');
                return;
            }

            // Save to memoData
            memoData[currentQuestionId] = {
                content: content,
                notes: notes
            };

            // Update status badge
            const badge = document.querySelector(`.memo-status-badge[data-question-id="${currentQuestionId}"]`);
            if (badge) {
                badge.innerHTML = '<i class="fas fa-check-circle text-success"></i> Memo Added';
            }

            // Update hidden input
            memoDataInput.value = JSON.stringify(memoData);

            // Close modal
            memoEditorModal.hide();
        });

        // Copy Question Button
        document.querySelectorAll('.copy-question-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const questionRow = this.closest('.question-row');
                const questionText = questionRow.querySelector('small.text-muted').textContent.trim();
                navigator.clipboard.writeText(questionText).then(() => {
                    const originalClass = this.className;
                    this.className = this.className.replace('btn-outline-secondary', 'btn-success');
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        this.className = originalClass;
                        this.innerHTML = '<i class="fas fa-copy"></i>';
                    }, 1500);
                });
            });
        });

        // Remove Question Button
        document.querySelectorAll('.remove-question-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                if (confirm('Remove this question from randomisation?')) {
                    this.closest('.question-row').style.opacity = '0.5';
                    this.closest('.question-row').style.pointerEvents = 'none';
                    // Mark as removed (you can add a hidden input to track this)
                }
            });
        });

        // Form Submit
        document.getElementById('memoRandomisationForm').addEventListener('submit', function (e) {
            const memoCount = Object.keys(memoData).length;
            if (memoCount === 0) {
                const warning = confirm(
                    'No memos added yet.\n\nContinue with randomisation without memos?'
                );
                if (!warning) {
                    e.preventDefault();
                    return;
                }
            }
        });
    });
</script>